---
interface Props {
  title: string;
  image: string;
  imageAlt?: string;
  ctaText: string;
  ctaUrl: string;
  badge?: string;
  badgeColor?: "green" | "blue" | "orange" | "violet";
  features: string[];
  urgencyText?: string;
  // Layout controls
  imagePosition?: "top" | "bottom" | "left" | "right";
  mobileImagePosition?: "top" | "bottom";
  // Visibility controls
  hideImageOnMobile?: boolean;
  hideImageOnDesktop?: boolean;
  hideBadgeOnMobile?: boolean;
  hideBadgeOnDesktop?: boolean;
  hideTitleOnMobile?: boolean;
  hideTitleOnDesktop?: boolean;
  hideFeaturesOnMobile?: boolean;
  hideFeaturesOnDesktop?: boolean;
  hideUrgencyOnMobile?: boolean;
  hideUrgencyOnDesktop?: boolean;
  hideCtaOnMobile?: boolean;
  hideCtaOnDesktop?: boolean;
  // Popup controls
  imagePopupOnDesktop?: boolean;
}

const {
  title,
  image,
  imageAlt = "Produktbild",
  ctaText,
  ctaUrl,
  badge,
  badgeColor = "green",
  features,
  urgencyText,
  // Layout defaults
  imagePosition = "left",
  mobileImagePosition = "top",
  // Visibility defaults
  hideImageOnMobile = false,
  hideImageOnDesktop = false,
  hideBadgeOnMobile = false,
  hideBadgeOnDesktop = false,
  hideTitleOnMobile = false,
  hideTitleOnDesktop = false,
  hideFeaturesOnMobile = false,
  hideFeaturesOnDesktop = false,
  hideUrgencyOnMobile = false,
  hideUrgencyOnDesktop = false,
  hideCtaOnMobile = false,
  hideCtaOnDesktop = false,
  // Popup defaults
  imagePopupOnDesktop = false,
} = Astro.props;

const badgeColors = {
  green: "bg-emerald-500/20 text-emerald-400 border-emerald-500/30",
  blue: "bg-blue-500/20 text-blue-400 border-blue-500/30",
  orange: "bg-orange-500/20 text-orange-400 border-orange-500/30",
  violet: "bg-violet-500/20 text-violet-400 border-violet-500/30",
};

const ctaColors = {
  green: "bg-emerald-600 hover:bg-emerald-500",
  blue: "bg-blue-600 hover:bg-blue-500",
  orange: "bg-orange-600 hover:bg-orange-500",
  violet: "bg-violet-600 hover:bg-violet-500",
};

// Helper function for visibility classes
const getVisibilityClass = (hideOnMobile: boolean, hideOnDesktop: boolean) => {
  if (hideOnMobile && hideOnDesktop) return "hidden";
  if (hideOnMobile) return "hidden md:block";
  if (hideOnDesktop) return "block md:hidden";
  return "";
};

const badgeVisibility = getVisibilityClass(
  hideBadgeOnMobile,
  hideBadgeOnDesktop,
);
const titleVisibility = getVisibilityClass(
  hideTitleOnMobile,
  hideTitleOnDesktop,
);
const featuresVisibility = getVisibilityClass(
  hideFeaturesOnMobile,
  hideFeaturesOnDesktop,
);
const urgencyVisibility = getVisibilityClass(
  hideUrgencyOnMobile,
  hideUrgencyOnDesktop,
);
const ctaVisibility = getVisibilityClass(hideCtaOnMobile, hideCtaOnDesktop);

// Grid order classes based on position
const getGridOrderClasses = () => {
  const mobileOrder = mobileImagePosition === "bottom" ? "order-2" : "order-1";
  const desktopOrder = imagePosition === "right" ? "md:order-2" : "md:order-1";
  return `${mobileOrder} ${desktopOrder}`;
};

const getContentOrderClasses = () => {
  const mobileOrder = mobileImagePosition === "bottom" ? "order-1" : "order-2";
  const desktopOrder = imagePosition === "right" ? "md:order-1" : "md:order-2";
  return `${mobileOrder} ${desktopOrder}`;
};

const imageOrderClasses = getGridOrderClasses();
const contentOrderClasses = getContentOrderClasses();

// Unique ID for popup
const popupId = `product-popup-${Math.random().toString(36).slice(2, 11)}`;
---

<aside
  class="my-8 overflow-hidden rounded-2xl border border-zinc-700/50 bg-zinc-800/50"
>
  <div class="grid gap-6 p-6 md:grid-cols-2 md:items-center md:gap-8">
    <!-- Bild -->
    {
      !hideImageOnMobile && (
        <div class:list={["relative md:hidden", imageOrderClasses]}>
          {badge && (
            <span
              class:list={[
                "absolute -top-2 -left-2 z-10 rounded-lg border px-3 py-1 text-xs font-semibold",
                badgeColors[badgeColor],
                badgeVisibility,
              ]}
            >
              {badge}
            </span>
          )}
          <div class="overflow-hidden rounded-xl bg-gradient-to-br from-zinc-700/50 to-zinc-800/50 p-4">
            <img
              src={image}
              alt={imageAlt}
              class="mx-auto h-auto max-h-64 w-auto object-contain"
              loading="lazy"
            />
          </div>
        </div>
      )
    }

    <!-- Desktop Bild (mit optionalem Popup) -->
    {
      !hideImageOnDesktop && (
        <div class:list={["relative hidden md:block", imageOrderClasses]}>
          {badge && (
            <span
              class:list={[
                "absolute -top-2 -left-2 z-10 rounded-lg border px-3 py-1 text-xs font-semibold",
                badgeColors[badgeColor],
                badgeVisibility,
              ]}
            >
              {badge}
            </span>
          )}
          <div class="overflow-hidden rounded-xl bg-gradient-to-br from-zinc-700/50 to-zinc-800/50 p-4">
            {imagePopupOnDesktop ? (
              <button
                type="button"
                data-popup-trigger={popupId}
                class="group relative w-full cursor-zoom-in"
              >
                <img
                  src={image}
                  alt={imageAlt}
                  class="mx-auto h-auto max-h-64 w-auto object-contain transition-transform group-hover:scale-105"
                  loading="lazy"
                />
                <div class="absolute inset-0 flex items-center justify-center bg-black/0 transition-colors group-hover:bg-black/20">
                  <svg
                    class="h-10 w-10 text-white opacity-0 transition-opacity group-hover:opacity-100"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke-width="1.5"
                    stroke="currentColor"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      d="m21 21-5.197-5.197m0 0A7.5 7.5 0 1 0 5.196 5.196a7.5 7.5 0 0 0 10.607 10.607ZM10.5 7.5v6m3-3h-6"
                    />
                  </svg>
                </div>
              </button>
            ) : (
              <img
                src={image}
                alt={imageAlt}
                class="mx-auto h-auto max-h-64 w-auto object-contain"
                loading="lazy"
              />
            )}
          </div>
        </div>
      )
    }

    <!-- Content -->
    <div class:list={["flex flex-col", contentOrderClasses]}>
      <h4 class:list={["mb-4 text-xl font-bold text-white", titleVisibility]}>
        {title}
      </h4>

      <ul class:list={["mb-4 space-y-2", featuresVisibility]}>
        {
          features.map((feature) => (
            <li class="flex items-start gap-2 text-sm text-zinc-300">
              <svg
                class={`mt-0.5 h-5 w-5 shrink-0 ${badgeColor === "green" ? "text-emerald-400" : badgeColor === "blue" ? "text-blue-400" : badgeColor === "orange" ? "text-orange-400" : "text-violet-400"}`}
                fill="none"
                viewBox="0 0 24 24"
                stroke-width="2"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  d="m4.5 12.75 6 6 9-13.5"
                />
              </svg>
              <span set:html={feature} />
            </li>
          ))
        }
      </ul>

      {
        urgencyText && (
          <p class:list={["mb-4 text-sm text-zinc-400", urgencyVisibility]}>
            <span class="font-semibold text-orange-400">Hinweis:</span>{" "}
            {urgencyText}
          </p>
        )
      }

      <a
        href={ctaUrl}
        target="_blank"
        rel="noopener noreferrer sponsored"
        class:list={[
          "inline-flex items-center justify-center gap-2 rounded-lg px-6 py-3 text-sm font-semibold text-white transition-colors",
          ctaColors[badgeColor],
          ctaVisibility,
        ]}
      >
        {ctaText}
        <svg
          class="h-4 w-4"
          fill="none"
          viewBox="0 0 24 24"
          stroke-width="2"
          stroke="currentColor"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            d="M13.5 6H5.25A2.25 2.25 0 0 0 3 8.25v10.5A2.25 2.25 0 0 0 5.25 21h10.5A2.25 2.25 0 0 0 18 18.75V10.5m-10.5 6L21 3m0 0h-5.25M21 3v5.25"
          ></path>
        </svg>
      </a>
    </div>
  </div>
</aside>

<!-- Popup Modal -->
{
  imagePopupOnDesktop && (
    <div
      id={popupId}
      class="fixed inset-0 z-50 hidden items-center justify-center bg-black/80 p-4 backdrop-blur-sm"
      data-popup-modal
    >
      <button
        type="button"
        data-popup-close={popupId}
        class="absolute top-4 right-4 rounded-full bg-white/10 p-2 text-white transition-colors hover:bg-white/20"
      >
        <svg
          class="h-6 w-6"
          fill="none"
          viewBox="0 0 24 24"
          stroke-width="2"
          stroke="currentColor"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            d="M6 18 18 6M6 6l12 12"
          />
        </svg>
      </button>
      <div class="max-h-[90vh] max-w-4xl overflow-auto">
        <img
          src={image}
          alt={imageAlt}
          class="h-auto w-full rounded-lg object-contain"
          loading="lazy"
        />
      </div>
    </div>
  )
}

<script>
  // Popup functionality
  document.addEventListener("DOMContentLoaded", () => {
    // Open popup
    document.querySelectorAll("[data-popup-trigger]").forEach((trigger) => {
      trigger.addEventListener("click", () => {
        const popupId = trigger.getAttribute("data-popup-trigger");
        const popup = document.getElementById(popupId!);
        if (popup) {
          popup.classList.remove("hidden");
          popup.classList.add("flex");
          document.body.style.overflow = "hidden";
        }
      });
    });

    // Close popup
    document.querySelectorAll("[data-popup-close]").forEach((closeBtn) => {
      closeBtn.addEventListener("click", () => {
        const popupId = closeBtn.getAttribute("data-popup-close");
        const popup = document.getElementById(popupId!);
        if (popup) {
          popup.classList.add("hidden");
          popup.classList.remove("flex");
          document.body.style.overflow = "";
        }
      });
    });

    // Close on backdrop click
    document.querySelectorAll("[data-popup-modal]").forEach((modal) => {
      modal.addEventListener("click", (e) => {
        if (e.target === modal) {
          modal.classList.add("hidden");
          modal.classList.remove("flex");
          document.body.style.overflow = "";
        }
      });
    });

    // Close on Escape key
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape") {
        document.querySelectorAll("[data-popup-modal]").forEach((modal) => {
          modal.classList.add("hidden");
          modal.classList.remove("flex");
          document.body.style.overflow = "";
        });
      }
    });
  });
</script>
