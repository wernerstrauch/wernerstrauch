---
/**
 * LocationGrid Section Component
 *
 * Displays a grid of location cards with images and hover effects.
 * Each card links to the location detail page.
 * Includes filter by Bundesland functionality.
 *
 * @example YAML Usage:
 * ```yaml
 * component: LocationGrid
 * content:
 *   badge: "Standorte"
 *   badgeIcon: "heroicons:map-pin-16-solid"
 *   headline: "KI aus dem Ruhrgebiet für <em>ganz Deutschland</em>"
 *   description: "Wir sind für Sie da - bundesweit."
 * ```
 */
import Container from "@components/shared/Container.astro";
import { Icon } from "astro-icon/components";
import type { SectionVariant } from "../../types";
import { getCollection, type CollectionEntry } from "astro:content";
import { getImage } from "astro:assets";
import type { ImageMetadata } from "astro";

type LocationEntry = CollectionEntry<"locations">;

interface Props {
  sectionVariant?: SectionVariant;
  badge?: string;
  badgeIcon?: string;
  headline?: string;
  description?: string;
}

const {
  sectionVariant = "dark",
  badge,
  badgeIcon = "heroicons:map-pin-16-solid",
  headline,
  description,
} = Astro.props;

// Load all location images from src/assets
const images = import.meta.glob<{ default: ImageMetadata }>(
  "/src/assets/**/*.{png,jpg,jpeg,webp}",
);

// Helper function to resolve and optimize image
async function resolveImage(imagePath: string | undefined): Promise<string> {
  if (!imagePath) return "";

  // Convert YAML path to asset path: /ki-agentur/locations/berlin.jpg -> /src/assets/ki-agentur/locations/berlin.jpg
  const assetPath = imagePath.startsWith("/")
    ? `/src/assets${imagePath}`
    : `/src/assets/${imagePath}`;

  if (images[assetPath]) {
    try {
      const imageModule = await images[assetPath]();
      const optimized = await getImage({
        src: imageModule.default,
        width: 800,
        height: 600,
        format: "webp",
      });
      return optimized.src;
    } catch {
      // Fallback to original path if optimization fails
      return imagePath;
    }
  }

  // Fallback: return original path (for public folder images)
  return imagePath;
}

// Load all locations
const locations = await getCollection("locations");

// Separate Bundesländer and Städte
const bundeslaender = locations
  .filter((loc: LocationEntry) => loc.data.type === "bundesland")
  .sort((a: LocationEntry, b: LocationEntry) => a.data.order - b.data.order);

const staedte = locations
  .filter((loc: LocationEntry) => loc.data.type !== "bundesland")
  .sort((a: LocationEntry, b: LocationEntry) => a.data.order - b.data.order);

// All locations sorted: städte first, then bundesländer
const allLocationsSorted = [...staedte, ...bundeslaender];

// Create data structure for Alpine.js with optimized images
const locationsData = await Promise.all(
  allLocationsSorted.map(async (loc: LocationEntry) => ({
    slug: loc.data.slug,
    name: loc.data.name,
    region: loc.data.region,
    cardText: loc.data.cardText || null,
    image: await resolveImage(loc.data.image),
    type: loc.data.type || "stadt",
    parent: loc.data.parent || null,
  })),
);

const bundeslaenderData = bundeslaender.map((loc: LocationEntry) => ({
  slug: loc.data.slug,
  name: loc.data.name,
}));

// Process headline: replace <em> tags with styled spans
const highlightStyle = `color: var(--section-accent);`;
const processedHeadline = headline
  ? headline.replace(
      /<em>(.*?)<\/em>/g,
      `<span style="${highlightStyle}">$1</span>`,
    )
  : "";
---

<Container
  class="location-grid-section max-w-[100rem]"
  data-variant={sectionVariant}
>
  <div
    x-data={`{
      activeFilter: 'alle',
      bundeslaender: ${JSON.stringify(bundeslaenderData)}
    }`}
  >
    {/* Header */}
    <div class="mb-8 text-center">
      {
        badge && (
          <div class="blur-in mb-4 flex justify-center">
            <div class="location-grid__badge shadow-inner-blur flex items-center rounded-full">
              <div class="location-grid__badge-inner flex h-full w-full items-center space-x-2 rounded-full border px-4 py-1.5">
                <Icon
                  name={badgeIcon}
                  class="location-grid__badge-icon h-4 w-4"
                />
                <span class="location-grid__badge-text text-sm font-medium">
                  {badge}
                </span>
              </div>
            </div>
          </div>
        )
      }

      {
        headline && (
          <h1
            class="location-grid__headline scale-up text-3xl leading-tight font-bold sm:text-4xl lg:text-5xl"
            style="transition-delay: 100ms;"
            set:html={processedHeadline}
          />
        )
      }

      {
        description && (
          <p
            class="location-grid__description fade-up mx-auto mt-4 max-w-2xl text-lg"
            style="transition-delay: 200ms;"
          >
            {description}
          </p>
        )
      }
    </div>

    {/* Filter Buttons */}
    <div
      class="fade-up mb-10 flex flex-wrap justify-center gap-2"
      style="transition-delay: 250ms;"
    >
      <button
        type="button"
        class="location-filter-btn"
        :class="{ 'location-filter-btn--active': activeFilter === 'alle' }"
        @click="activeFilter = 'alle'"
      >
        Alle Standorte
      </button>
      <template x-for="bl in bundeslaender" :key="bl.slug">
        <button
          type="button"
          class="location-filter-btn"
          :class="{ 'location-filter-btn--active': activeFilter === bl.slug }"
          @click="activeFilter = bl.slug"
          x-text="bl.name"></button>
      </template>
    </div>

    {/* Location Cards Grid - Server-side rendered for SEO */}
    <div
      class="grid grid-cols-1 gap-6 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4"
    >
      {
        locationsData.map((location) => (
          <a
            href={`/standorte/${location.slug}`}
            class="location-card group overflow-hidden transition-all duration-300"
            data-location-slug={location.slug}
            data-location-parent={location.parent || ""}
            data-location-type={location.type}
            x-show={`activeFilter === 'alle' || '${location.slug}' === activeFilter || '${location.parent || ""}' === activeFilter`}
            x-transition:enter="transition ease-out duration-300"
            x-transition:enter-start="opacity-0 transform translate-y-4"
            x-transition:enter-end="opacity-100 transform translate-y-0"
          >
            {/* Image */}
            <div class="relative aspect-[4/3] overflow-hidden">
              <img
                src={location.image}
                alt={`Bild von ${location.name}`}
                loading="lazy"
                class="absolute inset-0 h-full w-full object-cover grayscale transition-transform duration-300 group-hover:scale-105"
              />
              {/* Primary color overlay */}
              <div class="location-card__overlay absolute inset-0" />
              {/* Hover gradient */}
              <div class="absolute inset-0 bg-gradient-to-t from-black/40 to-transparent opacity-0 transition-opacity duration-300 group-hover:opacity-100" />
            </div>

            {/* Content */}
            <div class="location-card__content flex flex-col gap-3 px-4 py-6 lg:px-5 lg:py-8">
              <h2 class="location-card__title text-xl leading-tight font-semibold tracking-tight sm:text-2xl">
                {location.name}
              </h2>
              <p class="location-card__region text-sm font-medium">
                {location.cardText || location.region}
              </p>
              <span class="location-card__link inline-flex items-center gap-2 font-bold transition-opacity group-hover:opacity-80">
                <span>Mehr erfahren</span>
                <svg
                  class="h-4 w-4 transition-transform group-hover:translate-x-1"
                  xmlns="http://www.w3.org/2000/svg"
                  viewBox="0 0 16 16"
                  fill="currentColor"
                >
                  <path
                    fill-rule="evenodd"
                    d="M2 8a.75.75 0 0 1 .75-.75h8.69L8.22 4.03a.75.75 0 0 1 1.06-1.06l4.5 4.5a.75.75 0 0 1 0 1.06l-4.5 4.5a.75.75 0 0 1-1.06-1.06l3.22-3.22H2.75A.75.75 0 0 1 2 8Z"
                    clip-rule="evenodd"
                  />
                </svg>
              </span>
            </div>
          </a>
        ))
      }
    </div>
  </div>
</Container>

<style>
  /* ========================================
     Uses --section-* variables set by data-section-theme
     attribute on parent Section component
     ======================================== */

  /* Badge styles */
  .location-grid__badge {
    background: color-mix(in srgb, var(--section-accent) 15%, transparent);
  }

  .location-grid__badge-inner {
    border-color: color-mix(in srgb, var(--section-accent) 30%, transparent);
  }

  .location-grid__badge-icon {
    color: var(--section-accent);
  }

  .location-grid__badge-text {
    color: var(--section-text);
  }

  /* Headline & description */
  .location-grid__headline {
    color: var(--section-text);
  }

  .location-grid__description {
    color: var(--section-text-muted);
  }

  /* Filter buttons */
  .location-filter-btn {
    padding: 0.5rem 1rem;
    border-radius: 9999px;
    font-size: 0.875rem;
    font-weight: 500;
    transition: all 0.2s ease;
    background: color-mix(in srgb, var(--section-text) 10%, transparent);
    color: var(--section-text-muted);
    border: 1px solid color-mix(in srgb, var(--section-text) 15%, transparent);
  }

  .location-filter-btn:hover {
    background: color-mix(in srgb, var(--section-text) 15%, transparent);
    color: var(--section-text);
  }

  .location-filter-btn--active {
    background: var(--section-accent);
    color: var(--section-bg);
    border-color: var(--section-accent);
  }

  .location-filter-btn--active:hover {
    background: var(--section-accent);
    color: var(--section-bg);
  }

  /* Location cards */
  .location-card {
    background: var(--section-card-bg);
    transition:
      transform 0.3s ease,
      box-shadow 0.3s ease;
  }

  .location-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
  }

  .location-card__content {
    background: var(--section-card-bg);
  }

  .location-card__title {
    color: var(--section-text);
  }

  .location-card__region {
    color: var(--section-text-muted);
  }

  .location-card__link {
    color: var(--section-text);
  }

  /* Primary color overlay on images - accent tint */
  .location-card__overlay {
    background-color: color-mix(
      in srgb,
      var(--section-accent) 50%,
      transparent
    );
    mix-blend-mode: multiply;
  }

  .location-card__overlay img {
    mix-blend-mode: multiply;
  }
</style>
