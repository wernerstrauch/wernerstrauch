---
/**
 * CaseHero Section Component
 *
 * Hero section for case study detail pages with customer name, tags, description,
 * KPIs and device mockup images or 3D model.
 *
 * @example YAML Usage:
 * ```yaml
 * component: CaseHero
 * content:
 *   title: "Koawach"
 *   description: "Lorem ipsum dolor sit amet..."
 *   tags:
 *     - "UI/UX Design"
 *     - "Migration"
 *   kpis:
 *     - value: "50%"
 *       label: "Umsatzwachstum"
 *     - value: "26%"
 *       label: "Conversion Rate"
 *   images:
 *     desktop: "/path/to/desktop-mockup.png"
 *     mobile: "/path/to/mobile-mockup.png"
 *   # OR use phone mockups (from src/assets/images/digitalsprung/mockups/rendered/):
 *   phoneImages:
 *     left: "mockup_sprenger-mobile-pdp_left"
 *     right: "mockup_sprenger-mobile-home_right"
 *   # OR use 3D model:
 *   model3d:
 *     path: "/models/iphone/iphone_17_black.gltf"
 *     autoRotate: true
 * ```
 */
import Container from "@components/shared/Container.astro";
import { Image } from "astro:assets";
import type { SectionVariant } from "../../types";
import type { ImageMetadata } from "astro";

interface KPI {
  value: string;
  label: string;
}

interface Model3D {
  path: string;
  autoRotate?: boolean;
  screenImage?: string; // Custom screenshot for phone 1
  screenImage2?: string; // Custom screenshot for phone 2
}

interface PhoneImages {
  left?: string; // Mockup name (without .png) from mockups/rendered/
  right?: string;
}

interface Props {
  sectionVariant?: SectionVariant;
  title: string;
  description?: string;
  tags?: string[];
  kpis?: KPI[];
  images?: {
    desktop?: string;
    mobile?: string;
  };
  model3d?: Model3D;
  phoneImages?: PhoneImages;
}

const {
  sectionVariant = "dark",
  title,
  description,
  tags = [],
  kpis = [],
  images,
  model3d,
  phoneImages,
} = Astro.props;

const use3DModel = Boolean(model3d?.path);
const usePhoneImages = Boolean(phoneImages?.left || phoneImages?.right);

// Dynamic import for phone mockup images
const mockupImages = import.meta.glob<{ default: ImageMetadata }>(
  "/src/assets/digitalsprung/phones/mockups/rendered/*.png",
);

async function getMockupImage(
  input: string,
): Promise<ImageMetadata | string | null> {
  // If it's a full path (starts with /), return as-is for backwards compatibility
  if (input.startsWith("/")) {
    return input;
  }
  // Otherwise, load from mockups/rendered/
  const path = `/src/assets/digitalsprung/phones/mockups/rendered/${input}.png`;
  const loader = mockupImages[path];
  if (loader) {
    const module = await loader();
    return module.default;
  }
  return null;
}

const leftPhoneImage = phoneImages?.left
  ? await getMockupImage(phoneImages.left)
  : null;
const rightPhoneImage = phoneImages?.right
  ? await getMockupImage(phoneImages.right)
  : null;

// Helper to check if image is ImageMetadata (for Astro Image) or string (for img)
const isImageMetadata = (
  img: ImageMetadata | string | null,
): img is ImageMetadata => img !== null && typeof img !== "string";
---

<div class="case-hero overflow-visible" data-variant={sectionVariant}>
  <Container class="overflow-visible">
    <div
      class="relative flex flex-col pt-32 pb-8 lg:min-h-[460px] lg:flex-row lg:items-end lg:pb-24"
    >
      {/* Content */}
      <div class="relative z-10 max-w-xl">
        {/* Title */}
        <h1
          class="case-hero__title scale-up text-4xl leading-[1.1] font-semibold tracking-tight sm:text-5xl md:text-6xl lg:text-[64px]"
        >
          {title}
        </h1>

        {/* Tags */}
        {
          tags.length > 0 && (
            <div
              class="fade-up mt-4 flex flex-wrap gap-3"
              style="transition-delay: 100ms;"
            >
              {tags.map((tag) => (
                <span class="case-hero__tag rounded-full px-3 py-1 text-base">
                  {tag}
                </span>
              ))}
            </div>
          )
        }

        {/* Description */}
        {
          description && (
            <p
              class="case-hero__description fade-up mt-6 text-base leading-relaxed sm:text-lg"
              style="transition-delay: 200ms;"
            >
              {description}
            </p>
          )
        }

        {/* KPIs */}
        {
          kpis.length > 0 && (
            <div
              class="fade-up mt-6 flex gap-4 sm:mt-8 sm:flex-wrap sm:gap-6"
              style="transition-delay: 300ms;"
            >
              {kpis.map((kpi) => (
                <div class="case-hero__kpi flex items-start gap-2 py-1.5 pl-1.5 sm:gap-4 sm:py-2.5 sm:pl-2.5">
                  <div class="case-hero__kpi-bar h-full w-1 self-stretch rounded-full" />
                  <div class="flex flex-col">
                    <span class="case-hero__kpi-value text-2xl font-semibold tracking-tight sm:text-[35px]">
                      {kpi.value}
                    </span>
                    <span class="case-hero__kpi-label text-sm leading-relaxed sm:text-xl">
                      {kpi.label}
                    </span>
                  </div>
                </div>
              ))}
            </div>
          )
        }
      </div>

      {/* 3D Model - Desktop: absolute overflow, Mobile: below content */}
      {
        use3DModel && model3d && (
          <div
            class="case-hero__3d-container pointer-events-auto relative mt-8 h-[400px] w-full lg:absolute lg:top-0 lg:right-0 lg:mt-0 lg:h-[180%] lg:w-1/2"
            data-phone3d
            data-phone3d-model={model3d.path}
            data-phone3d-autorotate={
              model3d.autoRotate !== false ? "true" : "false"
            }
            data-phone3d-screen={model3d.screenImage || ""}
            data-phone3d-screen2={model3d.screenImage2 || ""}
          />
        )
      }

      {/* Static Phone Images with Parallax */}
      {
        !use3DModel &&
          usePhoneImages &&
          (leftPhoneImage || rightPhoneImage) && (
            <div class="case-hero__phones-container pointer-events-none relative mt-8 -mb-24 flex justify-center sm:-mb-32 lg:absolute lg:top-16 lg:right-0 lg:mt-0 lg:mb-0 lg:h-[200%] lg:w-1/2 lg:items-start lg:justify-end lg:pr-8">
              <div class="relative flex items-start" data-phone-parallax>
                {/* Left Phone (back) */}
                {leftPhoneImage && isImageMetadata(leftPhoneImage) ? (
                  <Image
                    src={leftPhoneImage}
                    alt="Phone Mockup"
                    class="case-hero__phone case-hero__phone--left blur-in relative z-10 h-auto w-[240px] object-contain sm:w-[300px] lg:w-[374px]"
                    style="transition-delay: 200ms;"
                    loading="eager"
                    widths={[240, 300, 374, 480, 600, 748]}
                    sizes="(max-width: 640px) 240px, (max-width: 1024px) 300px, 374px"
                  />
                ) : leftPhoneImage ? (
                  <img
                    src={leftPhoneImage}
                    alt="Phone Mockup"
                    class="case-hero__phone case-hero__phone--left blur-in relative z-10 h-auto w-[240px] object-contain sm:w-[300px] lg:w-[374px]"
                    style="transition-delay: 200ms;"
                    loading="eager"
                  />
                ) : null}
                {/* Right Phone (front) */}
                {rightPhoneImage && isImageMetadata(rightPhoneImage) ? (
                  <Image
                    src={rightPhoneImage}
                    alt="Phone Mockup"
                    class="case-hero__phone case-hero__phone--right blur-in relative z-20 -ml-28 h-auto w-[260px] object-contain sm:-ml-36 sm:w-[320px] lg:-ml-40 lg:w-[418px]"
                    style="transition-delay: 400ms;"
                    loading="eager"
                    widths={[260, 320, 418, 520, 640, 836]}
                    sizes="(max-width: 640px) 260px, (max-width: 1024px) 320px, 418px"
                  />
                ) : rightPhoneImage ? (
                  <img
                    src={rightPhoneImage}
                    alt="Phone Mockup"
                    class="case-hero__phone case-hero__phone--right blur-in relative z-20 -ml-28 h-auto w-[260px] object-contain sm:-ml-36 sm:w-[320px] lg:-ml-40 lg:w-[418px]"
                    style="transition-delay: 400ms;"
                    loading="eager"
                  />
                ) : null}
              </div>
            </div>
          )
      }

      {/* Device Mockups (fallback when no 3D model and no phone images) */}
      {
        !use3DModel && images && (images.desktop || images.mobile) && (
          <div class="pointer-events-none absolute top-0 right-0 hidden h-full w-1/2 lg:block">
            {images.desktop && (
              <img
                src={images.desktop}
                alt={`${title} Desktop`}
                class="blur-in absolute top-1/2 right-0 max-h-[500px] w-auto max-w-none -translate-y-1/2 object-contain"
                style="transition-delay: 200ms;"
                loading="eager"
              />
            )}
            {images.mobile && (
              <img
                src={images.mobile}
                alt={`${title} Mobile`}
                class="blur-in absolute top-1/3 left-0 z-10 max-h-[340px] w-auto object-contain"
                style="transition-delay: 400ms;"
                loading="eager"
              />
            )}
          </div>
        )
      }
    </div>
  </Container>
</div>

{/* Three.js Script for 3D Model - only included when use3DModel is true */}
<script>
  import { initPhone3D } from "@scripts/phone3d";

  document.addEventListener("DOMContentLoaded", () => {
    const containers = document.querySelectorAll<HTMLElement>("[data-phone3d]");

    containers.forEach((container) => {
      const modelPath = container.dataset.phone3dModel;
      if (modelPath) {
        initPhone3D({
          container,
          modelPath,
          autoRotate: container.dataset.phone3dAutorotate !== "false",
          screenImage: container.dataset.phone3dScreen || undefined,
          screenImage2: container.dataset.phone3dScreen2 || undefined,
        });
      }
    });
  });
</script>

<style>
  /* ========================================
     Base Colors - Dark variant
     ======================================== */
  .case-hero {
    --hero-title: #ffffff;
    --hero-description: #b1adbf;
    --hero-tag-bg: color-mix(in srgb, var(--accent) 10%, transparent);
    --hero-tag-border: color-mix(in srgb, var(--accent) 30%, transparent);
    --hero-tag-text: #ffffff;
    --hero-kpi-bar: var(--section-accent);
    --hero-kpi-value: #ffffff;
    --hero-kpi-label: #ffffff;
  }

  .case-hero[data-variant="white"],
  .case-hero[data-variant="light"] {
    --hero-title: #1c1c1e;
    --hero-description: #6d6b76;
    --hero-tag-bg: color-mix(in srgb, var(--section-accent) 10%, transparent);
    --hero-tag-border: color-mix(
      in srgb,
      var(--section-accent) 30%,
      transparent
    );
    --hero-tag-text: #1c1c1e;
    --hero-kpi-bar: var(--section-accent);
    --hero-kpi-value: #1c1c1e;
    --hero-kpi-label: #1c1c1e;
  }

  /* ========================================
     Apply Colors
     ======================================== */
  .case-hero__title {
    color: var(--hero-title);
  }

  .case-hero__description {
    color: var(--hero-description);
  }

  .case-hero__tag {
    background: var(--hero-tag-bg);
    border: 1px solid var(--hero-tag-border);
    color: var(--hero-tag-text);
  }

  .case-hero__kpi-bar {
    background: var(--hero-kpi-bar);
  }

  .case-hero__kpi-value {
    color: var(--hero-kpi-value);
  }

  .case-hero__kpi-label {
    color: var(--hero-kpi-label);
  }

  /* 3D Container */
  .case-hero__3d-container {
    opacity: 0;
    transition: opacity 0.8s ease-out;
    z-index: 20;
  }

  .case-hero__3d-container.loaded {
    opacity: 1;
  }

  .case-hero__3d-container :global(canvas) {
    display: block;
  }

  /* Phone Images */
  .case-hero__phones-container {
    z-index: 20;
  }

  .case-hero__phone {
    filter: drop-shadow(0 25px 50px rgba(0, 0, 0, 0.3));
  }

  /* Floating animation for back phone (left) - slower, subtle */
  .case-hero__phone--left {
    animation: float-back 6s ease-in-out infinite;
  }

  /* Floating animation for front phone (right) - slightly faster, more movement */
  .case-hero__phone--right {
    animation: float-front 5s ease-in-out infinite;
  }

  @keyframes float-back {
    0%,
    100% {
      transform: translateY(0);
    }
    50% {
      transform: translateY(-12px);
    }
  }

  @keyframes float-front {
    0%,
    100% {
      transform: translateY(0);
    }
    50% {
      transform: translateY(-18px);
    }
  }

  /* Reduced motion */
  @media (prefers-reduced-motion: reduce) {
    .case-hero img {
      transition: none;
    }

    .case-hero__3d-container {
      transition: none;
    }

    .case-hero__phone--left,
    .case-hero__phone--right {
      animation: none;
    }
  }
</style>
