---
import Container from "@components/shared/Container.astro";
import Button from "@components/shared/Button.astro";
import { Icon } from "astro-icon/components";
import type { SectionVariant } from "../../types";

interface Case {
  industry: string;
  metric: string;
  metricLabel: string;
  title: string;
  description: string;
  tags: string[];
  icon: string;
}

interface Props {
  sectionVariant?: SectionVariant;
  badge?: string;
  badgeIcon?: string;
  headline?: string;
  description?: string;
  cases?: Case[];
  ctaText?: string;
  ctaHref?: string;
}

const {
  sectionVariant = "light",
  badge = "Erfolgsgeschichten",
  badgeIcon = "heroicons:trophy-16-solid",
  headline = "Echte <em>Ergebnisse</em>",
  description = "Entdecke, wie andere Shops mit unserem holistischen Marketing-Ansatz messbar mehr Umsatz erzielen.",
  cases = [
    {
      industry: "Fashion E-Commerce",
      metric: "340%",
      metricLabel: "ROAS Steigerung",
      title: "Von 1,8 auf 6,2 ROAS in 6 Monaten",
      description:
        "Durch die Kombination aus optimierten Meta Ads und Klaviyo-Flows für Warenkorbabbrecher konnte der Kunde seinen Return on Ad Spend mehr als verdreifachen.",
      tags: ["Meta Ads", "Klaviyo", "Fashion"],
      icon: "heroicons:shopping-bag",
    },
    {
      industry: "Home & Living Shop",
      metric: "52%",
      metricLabel: "Mehr Wiederkäufer",
      title: "Kundenbindung durch E-Mail Marketing",
      description:
        "Mit gezielten Klaviyo E-Mail-Flows und Segmentierung steigerte der Shop den Anteil wiederkehrender Kunden massiv.",
      tags: ["Klaviyo", "Retention", "Automation"],
      icon: "heroicons:envelope",
    },
    {
      industry: "Nahrungsergänzung",
      metric: "+180%",
      metricLabel: "Organischer Traffic",
      title: "SEO-Strategie für nachhaltige Sichtbarkeit",
      description:
        "Eine fundierte SEO-Strategie mit optimierten Produktseiten und Content-Marketing führte zu einer Verdreifachung des organischen Traffics.",
      tags: ["SEO", "Content", "Onpage"],
      icon: "heroicons:magnifying-glass",
    },
  ],
  ctaText = "Jetzt Beratung anfragen",
  ctaHref = "#kontakt",
} = Astro.props;

// Determine button variant based on section theme
const isDarkVariant = sectionVariant === "dark" || sectionVariant === "primary";
const buttonVariant =
  sectionVariant === "primary"
    ? "white"
    : isDarkVariant
      ? "secondary-dark"
      : "secondary";

// Process headline: replace <em> tags with colored spans using CSS variable
const highlightStyle = `color: var(--section-accent);`;
const processedHeadline = headline.replace(
  /<em>(.*?)<\/em>/g,
  `<span style="${highlightStyle}">$1</span>`,
);
---

<Container
  id="cases"
  class="usecases-section max-w-[1200px]"
  data-variant={sectionVariant}
>
  {/* Header */}
  <div class="mb-16 text-center">
    <div class="blur-in mb-4 flex justify-center">
      <div
        class="usecases-badge shadow-inner-blur flex items-center rounded-full"
      >
        <div
          class="usecases-badge-inner flex h-full w-full items-center space-x-2 rounded-full border px-4 py-1.5"
        >
          <Icon name={badgeIcon} class="usecases-badge-icon h-4 w-4" />
          <span class="usecases-badge-text text-sm font-medium">
            {badge}
          </span>
        </div>
      </div>
    </div>
    <h2
      class="usecases-headline scale-up text-3xl leading-tight font-bold sm:text-4xl lg:text-5xl"
      style="transition-delay: 100ms;"
      set:html={processedHeadline}
    />
    <p
      class="usecases-description fade-up mx-auto mt-4 max-w-2xl text-lg"
      style="transition-delay: 200ms;"
    >
      {description}
    </p>
  </div>

  {/* Cases Grid */}
  <div class="cases-grid grid gap-6 md:grid-cols-3">
    {
      cases.map((caseItem, index) => (
        <div
          class="case-card usecases-card group relative overflow-hidden border transition-all duration-300"
          data-index={index}
        >
          {/* Spotlight glow */}
          <div class="case-glow pointer-events-none absolute inset-0 opacity-0 transition-opacity duration-300 group-hover:opacity-100" />

          {/* Metric Header */}
          <div class="usecases-card-header relative z-10 border-b p-6">
            <div class="flex items-center justify-between">
              <span class="usecases-industry-badge inline-flex items-center gap-2 rounded-full px-3 py-1 text-xs font-semibold tracking-wide uppercase">
                <span class="usecases-industry-dot h-1.5 w-1.5 animate-pulse rounded-full" />
                {caseItem.industry}
              </span>
            </div>
            <div class="mt-4">
              <span class="usecases-metric block text-5xl font-bold">
                {caseItem.metric}
              </span>
              <p class="usecases-metric-label mt-1 text-sm font-medium lg:text-base">
                {caseItem.metricLabel}
              </p>
            </div>
          </div>

          {/* Content */}
          <div class="relative z-10 p-6">
            <h3 class="usecases-card-title text-lg leading-snug font-bold lg:text-xl">
              {caseItem.title}
            </h3>
            <p
              class="usecases-card-description mt-3 text-sm leading-relaxed lg:text-base"
              set:html={caseItem.description}
            />

            {/* Tags */}
            <div class="mt-5 flex flex-wrap gap-2 lg:gap-3">
              {caseItem.tags.map((tag) => (
                <span class="usecases-tag rounded-full border px-3 py-1 text-xs font-medium transition-colors lg:text-sm">
                  {tag}
                </span>
              ))}
            </div>
          </div>

          {/* Hover line accent */}
          <div class="usecases-hover-line absolute bottom-0 left-0 h-1 w-0 transition-all duration-500 group-hover:w-full" />
        </div>
      ))
    }
  </div>

  {/* CTA */}
  <div class="mt-14 text-center">
    <Button href={ctaHref} variant={buttonVariant} size="lg">
      <span>{ctaText}</span>
      <Icon name="heroicons:arrow-right-16-solid" class="h-4 w-4" />
    </Button>
  </div>
</Container>

<script>
  function initCasesSpotlight(): void {
    const containers =
      document.querySelectorAll<HTMLDivElement>(".usecases-section");

    containers.forEach((container) => {
      const grid = container.querySelector<HTMLDivElement>(".cases-grid");
      if (!grid) return;

      const cards = grid.querySelectorAll<HTMLDivElement>(".case-card");

      grid.addEventListener("mousemove", (event: MouseEvent) => {
        cards.forEach((card) => {
          const rect = card.getBoundingClientRect();
          const x = event.clientX - rect.left;
          const y = event.clientY - rect.top;

          const glowElement = card.querySelector(".case-glow") as HTMLElement;
          if (glowElement) {
            // Use CSS variable for glow color
            const accentColor =
              getComputedStyle(card)
                .getPropertyValue("--section-accent")
                .trim() || "#a78bfa";
            glowElement.style.background = `radial-gradient(600px circle at ${x}px ${y}px, color-mix(in srgb, ${accentColor} 15%, transparent), transparent 40%)`;
          }
        });
      });

      grid.addEventListener("mouseleave", () => {
        cards.forEach((card) => {
          const glowElement = card.querySelector(".case-glow") as HTMLElement;
          if (glowElement) {
            glowElement.style.background = "none";
          }
        });
      });
    });
  }

  initCasesSpotlight();
</script>

<style>
  /* ========================================
     Uses --section-* variables set by data-section-theme
     attribute on parent Section component
     ======================================== */

  /* ========================================
     Badge styles
     ======================================== */
  .usecases-badge {
    background: color-mix(in srgb, var(--section-accent) 15%, transparent);
  }

  .usecases-badge-inner {
    border-color: color-mix(in srgb, var(--section-accent) 30%, transparent);
  }

  .usecases-badge-icon {
    color: var(--section-accent);
  }

  .usecases-badge-text {
    color: var(--section-text);
  }

  /* ========================================
     Headline styles
     ======================================== */
  .usecases-headline {
    color: var(--section-text);
  }

  .usecases-description {
    color: var(--section-text-muted);
  }

  /* ========================================
     Card styles
     ======================================== */
  .usecases-card {
    background: var(--section-card-bg);
    border-color: var(--section-card-border);
    transition:
      transform 0.3s ease,
      border-color 0.3s ease,
      box-shadow 0.3s ease;
  }

  .usecases-card:hover {
    transform: translateY(-4px);
    border-color: color-mix(in srgb, var(--section-accent) 40%, transparent);
    box-shadow: 0 20px 25px -5px
      color-mix(in srgb, var(--section-accent) 10%, transparent);
  }

  .usecases-card-header {
    background: linear-gradient(
      to bottom right,
      color-mix(in srgb, var(--section-accent) 5%, transparent),
      transparent
    );
    border-color: var(--section-card-border);
  }

  /* ========================================
     Industry badge styles
     ======================================== */
  .usecases-industry-badge {
    background: color-mix(in srgb, var(--section-accent) 15%, transparent);
    color: var(--section-accent);
  }

  .usecases-industry-dot {
    background: var(--section-accent);
  }

  /* ========================================
     Metric styles
     ======================================== */
  .usecases-metric {
    color: var(--section-accent);
  }

  .usecases-metric-label {
    color: var(--section-text-muted);
  }

  /* ========================================
     Card content styles
     ======================================== */
  .usecases-card-title {
    color: var(--section-text);
  }

  .usecases-card-description {
    color: var(--section-text-muted);
  }

  /* ========================================
     Tag styles
     ======================================== */
  .usecases-tag {
    background: color-mix(in srgb, var(--section-accent) 5%, transparent);
    border-color: color-mix(in srgb, var(--section-accent) 20%, transparent);
    color: var(--section-text-muted);
  }

  .group:hover .usecases-tag {
    background: color-mix(in srgb, var(--section-accent) 10%, transparent);
    border-color: color-mix(in srgb, var(--section-accent) 30%, transparent);
    color: var(--section-accent);
  }

  /* ========================================
     Hover line styles
     ======================================== */
  .usecases-hover-line {
    background: var(--section-accent);
  }
</style>
