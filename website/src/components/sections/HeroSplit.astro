---
import Button from "@components/shared/Button.astro";
import { Icon } from "astro-icon/components";
import { Image } from "astro:assets";
import type { ImageMetadata } from "astro";
import type { SectionVariant } from "../../types";

interface Props {
  sectionVariant?: SectionVariant;
  badge?: string;
  badgeIcon?: string;
  headline: string;
  subheadline: string;
  primaryCta?: string;
  primaryCtaHref?: string;
  secondaryCta?: string;
  secondaryCtaHref?: string;
  secondaryCtaOpenApplication?: boolean;
  image: ImageMetadata | string;
  imageAlt?: string;
  announcementText?: string;
  announcementLink?: string;
  announcementLinkText?: string;
}

const {
  sectionVariant = "light",
  badge,
  badgeIcon = "heroicons:sparkles-16-solid",
  headline,
  subheadline,
  primaryCta = "Kostenloses Erstgespr√§ch",
  primaryCtaHref,
  secondaryCta = "Erfolgsbeispiele ansehen",
  secondaryCtaHref = "#cases",
  secondaryCtaOpenApplication = false,
  image,
  imageAlt = "",
  announcementText,
  announcementLink,
  announcementLinkText = "Mehr erfahren",
} = Astro.props;

// Resolve image if it's a string (from YAML)
const assetsImages = import.meta.glob<{ default: ImageMetadata }>(
  "/src/assets/**/*.{png,jpg,jpeg,webp}",
);
const srcImages = import.meta.glob<{ default: ImageMetadata }>(
  "/src/images/**/*.{png,jpg,jpeg,webp}",
);
const images = { ...assetsImages, ...srcImages };

let resolvedImage: ImageMetadata | string | undefined;
if (typeof image === "string") {
  if (image.startsWith("/src/assets/") || image.startsWith("/src/images/")) {
    // Already a full asset path
    if (images[image]) {
      resolvedImage = (await images[image]()).default;
    } else {
      resolvedImage = image;
    }
  } else if (image.startsWith("/")) {
    // Public path - use as-is
    resolvedImage = image;
  } else {
    // Relative path - try /src/images/ first, then /src/assets/
    const imagesPath = `/src/images/${image}`;
    const assetsPath = `/src/assets/${image}`;
    if (images[imagesPath]) {
      resolvedImage = (await images[imagesPath]()).default;
    } else if (images[assetsPath]) {
      resolvedImage = (await images[assetsPath]()).default;
    }
  }
} else {
  resolvedImage = image;
}

const isPublicImage = typeof resolvedImage === "string";

// Determine button variants based on section theme
const isDarkVariant = sectionVariant === "dark" || sectionVariant === "primary";
const primaryButtonVariant = sectionVariant === "primary" ? "white" : "primary";
const secondaryButtonVariant = isDarkVariant ? "secondary-dark" : "secondary";

// Process headline:
// - <em> tags become circled words with animated SVG
// - <mark> tags become colored text only (no circle)
let emIndex = 0;
let processedHeadline = headline.replace(
  /<em>(.*?)<\/em>/g,
  (_match, content) => {
    const index = emIndex++;
    return `<span class="circled-word" data-circled-index="${index}">${content}<svg class="circled-word__svg" viewBox="0 0 800 350" fill="none" preserveAspectRatio="none" aria-hidden="true"><path class="circled-word__path" d="M253,-161 C253,-161 -284.789,-201.46 -376,-21 C-469,163 67.623,174.21 256,121 C564,34 250.829,-141.693 19.107,-116.936" transform="translate(400, 179) scale(0.9791)" stroke-linejoin="round" stroke-linecap="round" stroke-width="8" pathLength="1"/></svg></span>`;
  },
);
processedHeadline = processedHeadline.replace(
  /<mark>(.*?)<\/mark>/g,
  `<span class="highlighted-word">$1</span>`,
);
---

<div
  id="hero"
  class="herosplit-section relative mx-auto max-w-7xl pt-20 sm:pt-24 lg:min-h-[600px] lg:pt-0"
  data-variant={sectionVariant}
>
  <div class="relative z-10 lg:w-full lg:max-w-2xl">
    <div class="relative px-6 sm:py-24 lg:px-8 lg:py-32 lg:pr-0">
      <div class="mx-auto max-w-2xl lg:mx-0 lg:max-w-xl">
        {/* Announcement banner */}
        {
          announcementText && (
            <div class="blur-in mb-8 hidden sm:flex">
              <div class="herosplit-announcement relative rounded-full px-3 py-1 text-sm/6 ring-1">
                {announcementText}{" "}
                {announcementLink && (
                  <a
                    href={announcementLink}
                    class="herosplit-announcement-link font-semibold whitespace-nowrap"
                  >
                    <span aria-hidden="true" class="absolute inset-0" />
                    {announcementLinkText}{" "}
                    <span aria-hidden="true">&rarr;</span>
                  </a>
                )}
              </div>
            </div>
          )
        }

        {/* Badge */}
        {
          badge && (
            <div class="herosplit-badge blur-in shadow-inner-blur mb-6 inline-flex items-center rounded-full">
              <div class="herosplit-badge-inner flex h-full w-full items-center space-x-2 rounded-full border px-4 py-1.5">
                <Icon name={badgeIcon} class="herosplit-badge-icon h-4 w-4" />
                <span class="herosplit-badge-text text-sm font-medium">
                  {badge}
                </span>
              </div>
            </div>
          )
        }

        {/* Headline */}
        <h1
          class="herosplit-headline scale-up text-4xl leading-[1.1] font-bold tracking-tight text-pretty sm:text-5xl lg:text-6xl"
          style="transition-delay: 100ms;"
          set:html={processedHeadline}
        />

        {/* Subheadline */}
        <p
          class="herosplit-subheadline fade-up mt-6 text-lg font-medium text-pretty sm:text-xl/8"
          style="transition-delay: 200ms;"
        >
          {subheadline}
        </p>

        {/* CTAs */}
        <div
          class="fade-up mt-10 flex flex-col items-start gap-4 sm:flex-row sm:items-center sm:gap-5"
          style="transition-delay: 300ms;"
        >
          <Button
            data-open-funnel={!primaryCtaHref}
            href={primaryCtaHref}
            variant={primaryButtonVariant}
            size="lg"
          >
            <Icon name="heroicons:calendar-days-16-solid" class="h-4 w-4" />
            <span>{primaryCta}</span>
          </Button>
          <Button
            data-open-application={secondaryCtaOpenApplication || undefined}
            href={secondaryCtaOpenApplication ? undefined : secondaryCtaHref}
            variant={secondaryButtonVariant}
            size="lg"
          >
            <span>{secondaryCta}</span>
            <Icon name="heroicons:arrow-right-16-solid" class="h-4 w-4" />
          </Button>
        </div>
      </div>
    </div>
  </div>
</div>

{/* Image section - outside max-w-7xl to reach screen edge */}
<div
  class="herosplit-image-wrapper fade-up mt-8 lg:absolute lg:inset-y-0 lg:right-0 lg:mt-0 lg:w-1/2"
  style="transition-delay: 400ms;"
>
  <div
    class="herosplit-image-container relative h-64 w-full overflow-hidden sm:h-80 lg:h-full"
  >
    {
      resolvedImage && isPublicImage ? (
        <img
          src={resolvedImage as string}
          alt={imageAlt}
          class="h-full w-full object-cover object-center"
          loading="eager"
        />
      ) : resolvedImage ? (
        <Image
          src={resolvedImage as ImageMetadata}
          alt={imageAlt}
          class="h-full w-full object-cover object-center"
          widths={[640, 800, 1200, 1600]}
          sizes="(max-width: 1024px) 100vw, 50vw"
          loading="eager"
        />
      ) : null
    }
    {/* Gradient overlay for better text contrast on mobile */}
    <div
      class="herosplit-image-overlay absolute inset-0 bg-gradient-to-t to-transparent lg:hidden"
    >
    </div>
    {/* Bottom fade gradient for smooth transition to next section */}
    <div class="herosplit-bottom-fade"></div>
  </div>
</div>

<style>
  /* ========================================
     Uses --section-* variables set by data-section-theme
     attribute on parent Section component
     ======================================== */

  /* ========================================
     Image diagonal clip - masks the image instead of overlaying the grid
     ======================================== */
  @media (min-width: 1024px) {
    .herosplit-image-wrapper {
      /* Diagonal clip: flacher Winkel - 20% oben links, 0% unten links */
      clip-path: polygon(20% 0, 100% 0, 100% 100%, 0% 100%);
    }
  }

  /* ========================================
     Badge styles
     ======================================== */
  .herosplit-badge {
    background: color-mix(in srgb, var(--section-accent) 15%, transparent);
  }

  .herosplit-badge-inner {
    border-color: color-mix(in srgb, var(--section-accent) 30%, transparent);
  }

  .herosplit-badge-icon {
    color: var(--section-accent);
  }

  .herosplit-badge-text {
    color: var(--section-text);
  }

  /* ========================================
     Headline styles
     ======================================== */
  .herosplit-headline {
    color: var(--section-text);
  }

  .herosplit-subheadline {
    color: var(--section-text-muted);
  }

  /* ========================================
     Circled Word Animation
     Using :global() because content is injected via set:html
     ======================================== */
  .herosplit-headline :global(.circled-word) {
    position: relative;
    display: inline-block;
    white-space: nowrap;
  }

  /* Hand-drawn SVG circle */
  .herosplit-headline :global(.circled-word__svg) {
    position: absolute;
    top: 50%;
    left: 50%;
    width: 130%;
    height: 110%;
    transform: translate(-50%, -50%);
    pointer-events: none;
    overflow: visible;
  }

  .herosplit-headline :global(.circled-word__path) {
    stroke: var(--section-accent, #c8ff00);
    stroke-dasharray: 1;
    stroke-dashoffset: 1;
    transition: stroke-dashoffset 0.7s cubic-bezier(0.4, 0, 0.2, 1);
  }

  /* Animate when parent headline becomes visible */
  .herosplit-headline.is-visible :global(.circled-word__path) {
    stroke-dashoffset: 0;
  }

  /* Stagger animation for multiple circled words */
  .herosplit-headline.is-visible :global(.circled-word[data-circled-index="0"]) :global(.circled-word__path) {
    transition-delay: 0.5s;
  }

  .herosplit-headline.is-visible :global(.circled-word[data-circled-index="1"]) :global(.circled-word__path) {
    transition-delay: 0.8s;
  }

  .herosplit-headline.is-visible :global(.circled-word[data-circled-index="2"]) :global(.circled-word__path) {
    transition-delay: 1.1s;
  }

  /* Reduce motion for accessibility */
  @media (prefers-reduced-motion: reduce) {
    .herosplit-headline :global(.circled-word__path) {
      stroke-dashoffset: 0;
      transition: none;
    }
  }

  /* ========================================
     Highlighted Word (color only, no circle)
     ======================================== */
  .herosplit-headline :global(.highlighted-word) {
    color: var(--section-accent, #c8ff00);
  }

  /* ========================================
     Announcement styles
     ======================================== */
  .herosplit-announcement {
    color: var(--section-text-muted);
    --tw-ring-color: color-mix(in srgb, var(--section-text) 10%, transparent);
  }

  .herosplit-announcement:hover {
    --tw-ring-color: color-mix(in srgb, var(--section-text) 20%, transparent);
  }

  .herosplit-announcement-link {
    color: var(--section-accent);
  }

  /* ========================================
     Image styles
     ======================================== */
  .herosplit-image-container {
    background: color-mix(in srgb, var(--section-text-muted) 10%, transparent);
  }

  .herosplit-image-overlay {
    background: linear-gradient(
      to top,
      color-mix(in srgb, var(--section-bg) 40%, transparent),
      transparent
    );
  }

  /* ========================================
     Bottom fade for smooth section transition
     ======================================== */
  .herosplit-bottom-fade {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    height: 120px;
    background: linear-gradient(
      to bottom,
      transparent 0%,
      color-mix(in srgb, var(--section-bg) 20%, transparent) 30%,
      color-mix(in srgb, var(--section-bg) 60%, transparent) 60%,
      var(--section-bg) 100%
    );
    pointer-events: none;
    z-index: 1;
  }

  @media (min-width: 1024px) {
    .herosplit-bottom-fade {
      height: 180px;
      background: linear-gradient(
        to bottom,
        transparent 0%,
        color-mix(in srgb, var(--section-bg) 15%, transparent) 40%,
        color-mix(in srgb, var(--section-bg) 50%, transparent) 70%,
        var(--section-bg) 100%
      );
    }
  }
</style>

<script>
  import "@scripts/animations";
</script>
