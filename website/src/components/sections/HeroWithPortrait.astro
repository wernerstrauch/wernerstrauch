---
import Container from "@components/shared/Container.astro";
import Button from "@components/shared/Button.astro";
import Eyebrow from "@components/shared/Eyebrow.astro";
import { Icon } from "astro-icon/components";
import { Image } from "astro:assets";
import type { SectionVariant } from "../../types";

interface Props {
  sectionVariant?: SectionVariant;
  eyebrowText?: string;
  eyebrowIcon?: string;
  headline: string;
  subheadline?: string;
  primaryCta?: string;
  primaryCtaHref?: string;
  secondaryCta?: string;
  secondaryCtaHref?: string;
  image?: string;
  imageAlt?: string;
  imageScale?: number;
}

const {
  sectionVariant = "white",
  eyebrowText,
  eyebrowIcon = "heroicons:sparkles-16-solid",
  headline,
  subheadline,
  primaryCta,
  primaryCtaHref,
  secondaryCta,
  secondaryCtaHref,
  image,
  imageAlt = "",
  imageScale = 1,
} = Astro.props;

// Calculate scaled image sizes
const baseDesktopWidth = 504;
const baseDesktopWidthMd = 432;
const baseMobileWidth = 320;
const baseMobileWidthSm = 280;

const scaledDesktopWidth = Math.round(baseDesktopWidth * imageScale);
const scaledDesktopWidthMd = Math.round(baseDesktopWidthMd * imageScale);
const scaledMobileWidth = Math.round(baseMobileWidth * imageScale);
const scaledMobileWidthSm = Math.round(baseMobileWidthSm * imageScale);

// Dynamic image import
const images = import.meta.glob<{ default: ImageMetadata }>(
  "/src/images/**/*.{jpeg,jpg,png,gif,webp}",
);
let resolvedImage: ImageMetadata | null = null;
if (image) {
  const imagePath = image.startsWith("/") ? image : `/src/images/${image}`;
  if (images[imagePath]) {
    resolvedImage = (await images[imagePath]()).default;
  }
}

// Variant-based styles
const isDarkVariant = sectionVariant === "dark" || sectionVariant === "primary";

// Button variants
const primaryButtonVariant = sectionVariant === "primary" ? "white" : "primary";
const secondaryButtonVariant = isDarkVariant ? "secondary-dark" : "secondary";

// Process headline:
// - <em> tags become circled words with animated SVG
// - <mark> tags become colored text only (no circle)
let emIndex = 0;
let processedHeadline = headline.replace(
  /<em>(.*?)<\/em>/g,
  (_match, content) => {
    const index = emIndex++;
    return `<span class="circled-word" data-circled-index="${index}">${content}<svg class="circled-word__svg" viewBox="0 0 800 350" fill="none" preserveAspectRatio="none" aria-hidden="true"><path class="circled-word__path" d="M253,-161 C253,-161 -284.789,-201.46 -376,-21 C-469,163 67.623,174.21 256,121 C564,34 250.829,-141.693 19.107,-116.936" transform="translate(400, 179) scale(0.9791)" stroke-linejoin="round" stroke-linecap="round" stroke-width="8" pathLength="1"/></svg></span>`;
  },
);
processedHeadline = processedHeadline.replace(
  /<mark>(.*?)<\/mark>/g,
  `<span class="highlighted-word">$1</span>`,
);
---

<div class="hero-portrait" data-variant={sectionVariant}>
  {/* Portrait Image - Desktop: absolute to Section, Mobile: below content */}
  {
    resolvedImage && (
      <div class="hero-portrait__image hero-portrait__image--desktop" style={`--img-scale: ${imageScale};`}>
        <Image
          src={resolvedImage}
          alt={imageAlt}
          class="hero-portrait__image-img"
          widths={[400, 600, 800]}
          sizes="(max-width: 768px) 280px, (max-width: 1024px) 400px, 500px"
        />
      </div>
    )
  }

  <Container>
    <div class="mx-auto max-w-3xl lg:mx-0">
      {/* Eyebrow Text */}
      {
        eyebrowText && (
          <Eyebrow text={eyebrowText} icon={eyebrowIcon} class="mb-6" />
        )
      }

      {/* Headline */}
      <h1
        class="hero-portrait__headline scale-up text-[1.75rem] leading-[1.15] font-bold tracking-tight text-pretty sm:text-5xl lg:text-6xl"
        style="transition-delay: 100ms;"
        set:html={processedHeadline}
      />

      {/* Subheadline */}
      {
        subheadline && (
          <p
            class="hero-portrait__subheadline fade-up mt-8 text-lg font-medium text-pretty sm:text-xl/8"
            style="transition-delay: 200ms;"
          >
            {subheadline}
          </p>
        )
      }

      {/* CTAs */}
      {
        (primaryCta || secondaryCta) && (
          <div
            class="fade-up mt-10 flex flex-col items-start gap-4 sm:flex-row sm:items-center sm:gap-5"
            style="transition-delay: 300ms;"
          >
            {primaryCta && (
              <Button
                data-open-funnel={!primaryCtaHref}
                href={primaryCtaHref}
                variant={primaryButtonVariant}
                size="lg"
              >
                <Icon name="heroicons:calendar-days-16-solid" class="h-4 w-4" />
                <span>{primaryCta}</span>
              </Button>
            )}
            {secondaryCta && secondaryCtaHref && (
              <Button
                href={secondaryCtaHref}
                variant={secondaryButtonVariant}
                size="lg"
              >
                <span>{secondaryCta}</span>
                <Icon name="heroicons:arrow-right-16-solid" class="h-4 w-4" />
              </Button>
            )}
          </div>
        )
      }
    </div>

    {/* Portrait Image - Mobile only: below content, right-aligned */}
    {
      resolvedImage && (
        <div class="hero-portrait__image hero-portrait__image--mobile" style={`--img-scale: ${imageScale};`}>
          <Image
            src={resolvedImage}
            alt={imageAlt}
            class="hero-portrait__image-img"
            widths={[280, 320, 400]}
            sizes="(max-width: 640px) 280px, 320px"
          />
        </div>
      )
    }
  </Container>
</div>

<script>
  import "@scripts/animations";
</script>

<style>
  /* ========================================
     Hero Portrait Container - static so image references Section
     ======================================== */
  .hero-portrait {
    position: static;
    /* Desktop padding - matches xl padding from Section */
    padding-top: 6rem;
    padding-bottom: 10rem;
  }

  @media (min-width: 640px) {
    .hero-portrait {
      padding-top: 8rem;
      padding-bottom: 10rem;
    }
  }

  @media (min-width: 1024px) {
    .hero-portrait {
      padding-top: 10rem;
      padding-bottom: 10rem;
    }
  }

  /* Remove bottom padding on mobile when image overlaps */
  @media (max-width: 1024px) {
    .hero-portrait {
      margin-bottom: 0;
      padding-bottom: 0;
    }
  }

  /* ========================================
     Eyebrow styles
     ======================================== */
  .hero-portrait__eyebrow {
    color: var(--section-accent);
  }

  /* ========================================
     Headline styles
     ======================================== */
  .hero-portrait__headline {
    color: var(--section-text);
  }

  /* ========================================
     Subheadline styles
     ======================================== */
  .hero-portrait__subheadline {
    color: var(--section-text-muted);
  }

  /* ========================================
     Circled Word Animation
     Using :global() because content is injected via set:html
     ======================================== */
  .hero-portrait__headline :global(.circled-word) {
    position: relative;
    display: inline-block;
    white-space: nowrap;
  }

  /* Hand-drawn SVG circle */
  .hero-portrait__headline :global(.circled-word__svg) {
    position: absolute;
    top: 50%;
    left: 50%;
    width: 130%;
    height: 110%;
    transform: translate(-50%, -50%);
    pointer-events: none;
    overflow: visible;
  }

  .hero-portrait__headline :global(.circled-word__path) {
    stroke: #c8ff00; /* Lime */
    stroke-dasharray: 1;
    stroke-dashoffset: 1;
    transition: stroke-dashoffset 0.7s cubic-bezier(0.4, 0, 0.2, 1);
  }

  /* Animate when parent headline becomes visible */
  .hero-portrait__headline.is-visible :global(.circled-word__path) {
    stroke-dashoffset: 0;
  }

  /* Stagger animation for multiple circled words */
  .hero-portrait__headline.is-visible :global(.circled-word[data-circled-index="0"]) :global(.circled-word__path) {
    transition-delay: 0.5s;
  }

  .hero-portrait__headline.is-visible :global(.circled-word[data-circled-index="1"]) :global(.circled-word__path) {
    transition-delay: 0.8s;
  }

  .hero-portrait__headline.is-visible :global(.circled-word[data-circled-index="2"]) :global(.circled-word__path) {
    transition-delay: 1.1s;
  }

  /* Reduce motion for accessibility */
  @media (prefers-reduced-motion: reduce) {
    .hero-portrait__headline :global(.circled-word__path) {
      stroke-dashoffset: 0;
      transition: none;
    }
  }

  /* ========================================
     Highlighted Word (color only, no circle)
     ======================================== */
  .hero-portrait__headline :global(.highlighted-word) {
    color: #c8ff00; /* Lime */
  }

  /* ========================================
     Portrait Image - Desktop: absolute positioned to Section
     Hidden on mobile (< 1024px)
     ======================================== */
  .hero-portrait__image--desktop {
    position: absolute;
    right: 5%;
    bottom: 0;
    pointer-events: none;
    z-index: 20;
    display: block;
  }

  .hero-portrait__image--desktop .hero-portrait__image-img {
    height: auto;
    width: calc(504px * var(--img-scale, 1));
    max-width: none;
    object-fit: contain;
    object-position: bottom right;
    display: block;
  }

  @media (max-width: 1280px) {
    .hero-portrait__image--desktop .hero-portrait__image-img {
      width: calc(432px * var(--img-scale, 1));
    }
  }

  @media (max-width: 1024px) {
    .hero-portrait__image--desktop {
      display: none !important;
    }
  }

  /* ========================================
     Portrait Image - Mobile: below content, right-aligned
     Only visible on mobile (< 1024px)
     ======================================== */
  .hero-portrait__image--mobile {
    display: none !important;
  }

  @media (max-width: 1024px) {
    .hero-portrait__image--mobile {
      display: flex !important;
      justify-content: flex-end;
      margin-top: -150px;
      margin-right: -1rem;
      position: relative;
      z-index: 30;
    }

    .hero-portrait__image--mobile .hero-portrait__image-img {
      height: auto;
      width: calc(320px * var(--img-scale, 1));
      object-fit: contain;
      display: block;
    }
  }

  @media (max-width: 640px) {
    .hero-portrait__image--mobile .hero-portrait__image-img {
      width: calc(280px * var(--img-scale, 1));
    }
  }
</style>
