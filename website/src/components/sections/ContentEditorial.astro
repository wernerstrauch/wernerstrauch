---
import Container from "@components/shared/Container.astro";
import Eyebrow from "@components/shared/Eyebrow.astro";
import { Icon } from "astro-icon/components";
import type { SectionVariant } from "../../types";

interface FaqItem {
  question: string;
  answer: string;
}

interface ContentBlock {
  type: "text" | "headline" | "bullets" | "faq" | "highlight" | "pullquote";
  content: string | string[] | FaqItem[];
}

// Alternative format: sections with title and content
interface SectionItem {
  title: string;
  content: string;
}

interface Props {
  sectionVariant?: SectionVariant;
  eyebrow?: string;
  badge?: string; // Alias for eyebrow
  badgeIcon?: string;
  headline?: string;
  leadParagraph?: string;
  pullQuote?: string;
  pullQuoteAuthor?: string;
  leftColumn?: ContentBlock[];
  rightColumn?: ContentBlock[];
  sections?: SectionItem[]; // Alternative format
  showDropCap?: boolean;
  showSectionNumbers?: boolean;
}

const {
  sectionVariant = "dark",
  eyebrow,
  badge,
  badgeIcon = "heroicons:document-text-16-solid",
  headline = "E-Commerce <em>Beratung</em> mit System",
  leadParagraph,
  pullQuote,
  pullQuoteAuthor,
  leftColumn: leftColumnProp = [],
  rightColumn = [],
  sections = [],
  showDropCap = true,
  showSectionNumbers = false,
} = Astro.props;

// Use badge as eyebrow if eyebrow is not provided
const displayEyebrow = eyebrow || badge;

// Convert sections format to leftColumn format if sections is provided
let leftColumn: ContentBlock[] = leftColumnProp;
if (sections.length > 0 && leftColumnProp.length === 0) {
  leftColumn = sections.flatMap((section): ContentBlock[] => {
    const blocks: ContentBlock[] = [];
    if (section.title) {
      blocks.push({ type: "headline", content: section.title });
    }
    if (section.content) {
      blocks.push({ type: "text", content: section.content });
    }
    return blocks;
  });
}

// Process headline with accent highlights
const highlightStyle = `color: var(--section-accent);`;
const processedHeadline = headline.replace(
  /<em>(.*?)<\/em>/g,
  `<span style="${highlightStyle}">$1</span>`,
);

// Unique ID for Alpine.js
const uniqueId = `content-editorial-${Math.random().toString(36).substring(2, 11)}`;

// Section counter for numbered sections
let sectionCounter = 0;
---

<div class="content-editorial" data-variant={sectionVariant}>
  {/* Background Signet Watermark */}
  <svg
    class="editorial-signet"
    viewBox="0 0 568.43 423.16"
    fill="none"
    aria-hidden="true"
  >
    <path
      d="M568.43,0h-189.86c-57.83,0-110.7,36.49-136.56,94.25l-95.13,212.47c-21.25,47.46-58.51,83.55-103.59,100.33L0,423.16h189.86c57.83,0,110.7-36.49,136.56-94.25l95.13-212.47c21.25-47.46,58.51-83.55,103.59-100.33L568.43,0Z"
      fill="currentColor"
    />
  </svg>

  <Container class="z-10">
    {/* Header Section with optional Pull Quote */}
    <header class="editorial-header mb-12 lg:mb-16">
      <div class="editorial-header-grid">
        {/* Left: Headline Area */}
        <div class="editorial-header-content">
          {/* Eyebrow / Badge */}
          {displayEyebrow && (
            <div class="mb-6">
              <Eyebrow text={displayEyebrow} icon={badgeIcon} />
            </div>
          )}

          {/* Main Headline */}
          <h2
            class="editorial-headline scale-up text-3xl leading-tight font-bold sm:text-4xl lg:text-5xl"
            style="transition-delay: 100ms;"
            set:html={processedHeadline}
          />

          {/* Decorative Line */}
          <div class="editorial-line fade-up mt-6 lg:mt-8" style="transition-delay: 150ms;" aria-hidden="true"></div>

          {/* Lead Paragraph */}
          {leadParagraph && (
            <p
              class="editorial-lead fade-up mt-6 text-lg lg:text-xl"
              style="transition-delay: 200ms;"
              set:html={leadParagraph}
            />
          )}
        </div>

        {/* Right: Pull Quote (Desktop only in header) */}
        {pullQuote && (
          <aside class="editorial-pullquote-desktop fade-up" style="transition-delay: 250ms;">
            <blockquote>
              <p>„{pullQuote}"</p>
              {pullQuoteAuthor && (
                <footer>— {pullQuoteAuthor}</footer>
              )}
            </blockquote>
          </aside>
        )}
      </div>

      {/* Mobile Pull Quote */}
      {pullQuote && (
        <aside class="editorial-pullquote-mobile fade-up mt-8" style="transition-delay: 250ms;">
          <blockquote>
            <p>„{pullQuote}"</p>
            {pullQuoteAuthor && (
              <footer>— {pullQuoteAuthor}</footer>
            )}
          </blockquote>
        </aside>
      )}
    </header>

    {/* Main Content Grid - Two Columns */}
    <div class="editorial-grid">
      {/* Left Column - Primary Content (wider) */}
      <div class="editorial-col-left fade-up" style="transition-delay: 300ms;">
        {/* Vertical Accent Line */}
        <div class="editorial-vertical-line" aria-hidden="true"></div>

        <div class="editorial-content">
          {leftColumn.map((block, blockIndex) => {
            // Handle Drop Cap for first text block
            const isFirstText = showDropCap && block.type === "text" && blockIndex === 0;

            if (block.type === "text") {
              return (
                <p
                  class:list={[
                    "editorial-text",
                    isFirstText && "editorial-text--dropcap"
                  ]}
                  set:html={block.content as string}
                />
              );
            }

            if (block.type === "headline") {
              sectionCounter++;
              return (
                <h3 class="editorial-subheadline">
                  {showSectionNumbers && (
                    <span class="editorial-section-number" aria-hidden="true">
                      {String(sectionCounter).padStart(2, "0")}
                    </span>
                  )}
                  <span>{block.content as string}</span>
                </h3>
              );
            }

            if (block.type === "highlight") {
              return (
                <div class="editorial-highlight">
                  <Icon name="heroicons:light-bulb-16-solid" class="editorial-highlight-icon" />
                  <p set:html={block.content as string} />
                </div>
              );
            }

            if (block.type === "bullets") {
              return (
                <ul class="editorial-bullets">
                  {(block.content as string[]).map((item) => (
                    <li>
                      <span class="editorial-bullet-marker" aria-hidden="true"></span>
                      <span set:html={item} />
                    </li>
                  ))}
                </ul>
              );
            }

            if (block.type === "faq") {
              return (
                <div
                  class="editorial-faq"
                  x-data={`{ activeItem: null }`}
                  id={`${uniqueId}-left`}
                >
                  {(block.content as FaqItem[]).map((item, index) => (
                    <div class="editorial-faq-item">
                      <button
                        type="button"
                        class="editorial-faq-trigger"
                        x-on:click={`activeItem = activeItem === ${index} ? null : ${index}`}
                      >
                        <span class="editorial-faq-question">
                          {item.question}
                        </span>
                        <Icon
                          name="heroicons:chevron-down-16-solid"
                          class="editorial-faq-icon"
                          x-bind:class={`{ 'rotate-180': activeItem === ${index} }`}
                        />
                      </button>
                      <div
                        x-show={`activeItem === ${index}`}
                        x-collapse
                        class="overflow-hidden"
                      >
                        <p class="editorial-faq-answer">
                          {item.answer}
                        </p>
                      </div>
                    </div>
                  ))}
                </div>
              );
            }

            return null;
          })}
        </div>
      </div>

      {/* Right Column - Secondary Content (narrower) */}
      <div class="editorial-col-right fade-up" style="transition-delay: 350ms;">
        <div class="editorial-content">
          {rightColumn.map((block) => {
            if (block.type === "text") {
              return (
                <p class="editorial-text" set:html={block.content as string} />
              );
            }

            if (block.type === "headline") {
              sectionCounter++;
              return (
                <h3 class="editorial-subheadline">
                  {showSectionNumbers && (
                    <span class="editorial-section-number" aria-hidden="true">
                      {String(sectionCounter).padStart(2, "0")}
                    </span>
                  )}
                  <span>{block.content as string}</span>
                </h3>
              );
            }

            if (block.type === "highlight") {
              return (
                <div class="editorial-highlight">
                  <Icon name="heroicons:light-bulb-16-solid" class="editorial-highlight-icon" />
                  <p set:html={block.content as string} />
                </div>
              );
            }

            if (block.type === "bullets") {
              return (
                <ul class="editorial-bullets">
                  {(block.content as string[]).map((item) => (
                    <li>
                      <span class="editorial-bullet-marker" aria-hidden="true"></span>
                      <span set:html={item} />
                    </li>
                  ))}
                </ul>
              );
            }

            if (block.type === "faq") {
              return (
                <div
                  class="editorial-faq"
                  x-data={`{ activeItem: null }`}
                  id={`${uniqueId}-right`}
                >
                  {(block.content as FaqItem[]).map((item, index) => (
                    <div class="editorial-faq-item">
                      <button
                        type="button"
                        class="editorial-faq-trigger"
                        x-on:click={`activeItem = activeItem === ${index} ? null : ${index}`}
                      >
                        <span class="editorial-faq-question">
                          {item.question}
                        </span>
                        <Icon
                          name="heroicons:chevron-down-16-solid"
                          class="editorial-faq-icon"
                          x-bind:class={`{ 'rotate-180': activeItem === ${index} }`}
                        />
                      </button>
                      <div
                        x-show={`activeItem === ${index}`}
                        x-collapse
                        class="overflow-hidden"
                      >
                        <p class="editorial-faq-answer">
                          {item.answer}
                        </p>
                      </div>
                    </div>
                  ))}
                </div>
              );
            }

            return null;
          })}
        </div>
      </div>
    </div>
  </Container>
</div>

<style>
  /* ========================================
     Content Editorial - Magazine-Style Layout
     Clean, readable, no overlapping elements
     ======================================== */

  .content-editorial {
    position: relative;
    overflow: hidden;
  }

  /* ========================================
     Background Signet Watermark
     ======================================== */
  .editorial-signet {
    position: absolute;
    right: -100px;
    bottom: -50px;
    width: 400px;
    height: 300px;
    color: var(--section-accent);
    opacity: 0.03;
    pointer-events: none;
    z-index: 0;
  }

  @media (min-width: 1024px) {
    .editorial-signet {
      width: 550px;
      height: 410px;
      right: -80px;
      bottom: -80px;
    }
  }

  /* ========================================
     Header Section - Grid Layout
     ======================================== */
  .editorial-header-grid {
    display: block;
  }

  @media (min-width: 1024px) {
    .editorial-header-grid {
      display: grid;
      grid-template-columns: 1fr 320px;
      gap: 4rem;
      align-items: start;
    }
  }

  @media (min-width: 1280px) {
    .editorial-header-grid {
      grid-template-columns: 1fr 360px;
      gap: 5rem;
    }
  }

  .editorial-header-content {
    max-width: 700px;
  }

  @media (min-width: 1024px) {
    .editorial-header-content {
      max-width: none;
    }
  }

  .editorial-eyebrow {
    color: var(--section-accent);
    letter-spacing: 0.15em;
  }

  .editorial-headline {
    color: var(--section-text);
  }

  .editorial-line {
    width: 80px;
    height: 4px;
    background: linear-gradient(90deg, var(--section-accent), transparent);
  }

  .editorial-lead {
    color: var(--section-text-muted);
    font-weight: 400;
    line-height: 1.8;
    max-width: 640px;
  }

  /* ========================================
     Pull Quote - Desktop (in header grid)
     ======================================== */
  .editorial-pullquote-desktop {
    display: none;
  }

  @media (min-width: 1024px) {
    .editorial-pullquote-desktop {
      display: block;
      margin-top: 2.5rem;
    }
  }

  .editorial-pullquote-desktop blockquote,
  .editorial-pullquote-mobile blockquote {
    position: relative;
    padding: 1.5rem;
    background: color-mix(in srgb, var(--section-accent) 8%, transparent);
    border: 1px solid color-mix(in srgb, var(--section-accent) 20%, transparent);
  }

  .editorial-pullquote-desktop blockquote::before,
  .editorial-pullquote-mobile blockquote::before {
    content: "";
    position: absolute;
    top: -1px;
    left: 0;
    right: 0;
    height: 3px;
    background: var(--section-accent);
  }

  .editorial-pullquote-desktop p,
  .editorial-pullquote-mobile p {
    color: var(--section-text);
    font-size: 1.0625rem;
    font-weight: 500;
    font-style: italic;
    line-height: 1.6;
  }

  .editorial-pullquote-desktop footer,
  .editorial-pullquote-mobile footer {
    color: var(--section-accent);
    font-size: 0.875rem;
    font-weight: 600;
    margin-top: 1rem;
    font-style: normal;
  }

  /* ========================================
     Pull Quote - Mobile (below header)
     ======================================== */
  .editorial-pullquote-mobile {
    display: block;
  }

  @media (min-width: 1024px) {
    .editorial-pullquote-mobile {
      display: none;
    }
  }

  /* ========================================
     Content Grid - Two Columns
     ======================================== */
  .editorial-grid {
    display: grid;
    gap: 3rem;
  }

  @media (min-width: 1024px) {
    .editorial-grid {
      grid-template-columns: 1.3fr 0.7fr;
      gap: 4rem;
    }
  }

  @media (min-width: 1280px) {
    .editorial-grid {
      grid-template-columns: 1.4fr 0.6fr;
      gap: 5rem;
    }
  }

  /* ========================================
     Left Column - Primary Content
     ======================================== */
  .editorial-col-left {
    position: relative;
  }

  .editorial-vertical-line {
    position: absolute;
    left: -1.5rem;
    top: 0;
    bottom: 0;
    width: 2px;
    background: linear-gradient(
      180deg,
      var(--section-accent) 0%,
      color-mix(in srgb, var(--section-accent) 30%, transparent) 50%,
      transparent 100%
    );
    opacity: 0.4;
    display: none;
  }

  @media (min-width: 1024px) {
    .editorial-vertical-line {
      display: block;
    }
  }

  .editorial-content {
    display: flex;
    flex-direction: column;
    gap: 1.25rem;
  }

  /* ========================================
     Text Styles
     ======================================== */
  .editorial-text {
    color: var(--section-text-muted);
    font-size: 1rem;
    line-height: 1.85;
  }

  @media (min-width: 640px) {
    .editorial-text {
      font-size: 1.0625rem;
    }
  }

  /* Drop Cap - Editorial Touch */
  .editorial-text--dropcap::first-letter {
    float: left;
    font-size: 3.5rem;
    line-height: 0.85;
    font-weight: 700;
    color: var(--section-accent);
    margin-right: 0.625rem;
    margin-top: 0.1rem;
  }

  @media (min-width: 640px) {
    .editorial-text--dropcap::first-letter {
      font-size: 4.5rem;
      margin-right: 0.875rem;
    }
  }

  /* ========================================
     Subheadlines with Optional Numbers
     ======================================== */
  .editorial-subheadline {
    display: flex;
    align-items: baseline;
    gap: 0.75rem;
    color: var(--section-text);
    font-size: 1.25rem;
    font-weight: 700;
    margin-top: 1rem;
    margin-bottom: 0.25rem;
  }

  @media (min-width: 640px) {
    .editorial-subheadline {
      font-size: 1.375rem;
    }
  }

  .editorial-section-number {
    color: var(--section-accent);
    font-size: 0.875rem;
    font-weight: 600;
    opacity: 0.7;
    font-variant-numeric: tabular-nums;
  }

  /* ========================================
     Highlight Box
     ======================================== */
  .editorial-highlight {
    display: flex;
    gap: 1rem;
    padding: 1.25rem 1.5rem;
    background: color-mix(in srgb, var(--section-accent) 8%, transparent);
    border-left: 3px solid var(--section-accent);
    margin: 0.5rem 0;
  }

  .editorial-highlight-icon {
    width: 1.25rem;
    height: 1.25rem;
    color: var(--section-accent);
    flex-shrink: 0;
    margin-top: 0.125rem;
  }

  .editorial-highlight p {
    color: var(--section-text);
    font-size: 0.9375rem;
    line-height: 1.7;
    font-weight: 500;
  }

  /* ========================================
     Bullet Lists
     ======================================== */
  .editorial-bullets {
    display: flex;
    flex-direction: column;
    gap: 0.625rem;
    margin: 0.5rem 0;
    list-style: none;
    padding: 0;
  }

  .editorial-bullets li {
    display: flex;
    align-items: flex-start;
    gap: 0.875rem;
    color: var(--section-text-muted);
    font-size: 0.9375rem;
    line-height: 1.7;
  }

  .editorial-bullet-marker {
    width: 6px;
    height: 6px;
    background: var(--section-accent);
    flex-shrink: 0;
    margin-top: 0.55rem;
    transform: rotate(45deg);
  }

  /* ========================================
     Right Column - Sidebar Content
     ======================================== */
  .editorial-col-right {
    position: relative;
  }

  @media (min-width: 1024px) {
    .editorial-col-right {
      padding-left: 2rem;
      border-left: 1px solid color-mix(in srgb, var(--section-accent) 15%, transparent);
    }
  }

  .editorial-col-right .editorial-text {
    font-size: 0.9375rem;
  }

  .editorial-col-right .editorial-subheadline {
    font-size: 1.125rem;
    margin-top: 0;
  }

  .editorial-col-right .editorial-subheadline:not(:first-child) {
    margin-top: 1.5rem;
  }

  /* ========================================
     FAQ Accordion
     ======================================== */
  .editorial-faq {
    margin-top: 0.5rem;
  }

  .editorial-faq-item {
    border-bottom: 1px solid color-mix(in srgb, var(--section-text) 10%, transparent);
  }

  .editorial-faq-item:first-child {
    border-top: 1px solid color-mix(in srgb, var(--section-text) 10%, transparent);
  }

  .editorial-faq-trigger {
    display: flex;
    width: 100%;
    justify-content: space-between;
    align-items: center;
    padding: 1rem 0;
    text-align: left;
    background: none;
    border: none;
    cursor: pointer;
    transition: color 0.2s;
  }

  .editorial-faq-trigger:hover {
    color: var(--section-accent);
  }

  .editorial-faq-question {
    color: var(--section-text);
    font-weight: 600;
    font-size: 0.9375rem;
    padding-right: 1rem;
  }

  .editorial-faq-icon {
    width: 1rem;
    height: 1rem;
    color: var(--section-accent);
    flex-shrink: 0;
    transition: transform 0.3s ease;
  }

  .editorial-faq-answer {
    color: var(--section-text-muted);
    font-size: 0.9375rem;
    line-height: 1.7;
    padding-bottom: 1rem;
  }

  /* ========================================
     Link Styling
     ======================================== */
  .content-editorial :global(a) {
    color: var(--section-accent);
    font-weight: 500;
    text-decoration: underline;
    text-underline-offset: 3px;
    text-decoration-thickness: 1px;
    transition: all 0.2s;
  }

  .content-editorial :global(a:hover) {
    text-decoration-thickness: 2px;
    opacity: 0.85;
  }

  /* Strong text */
  .content-editorial :global(strong) {
    color: var(--section-text);
    font-weight: 600;
  }

</style>
