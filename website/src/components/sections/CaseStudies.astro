---
import Container from "@components/shared/Container.astro";
import { Icon } from "astro-icon/components";
import type { SectionVariant } from "../../types";

interface Case {
  title: string;
  context: string;
  challenge: string;
  approach: string;
  result: string;
}

interface Props {
  sectionVariant?: SectionVariant;
  headline?: string;
  cases?: Case[];
}

const {
  sectionVariant = "white",
  headline = "Ausgew√§hlte Projekte",
  cases = [],
} = Astro.props;

// Process headline:
// - <em> tags become circled words with animated SVG
// - <mark> tags become colored text only (no circle)
let emIndex = 0;
let processedHeadline = headline.replace(
  /<em>(.*?)<\/em>/g,
  (_match: string, content: string) => {
    const index = emIndex++;
    return `<span class="circled-word" data-circled-index="${index}">${content}<svg class="circled-word__svg" viewBox="0 0 800 350" fill="none" preserveAspectRatio="none" aria-hidden="true"><path class="circled-word__path" d="M253,-161 C253,-161 -284.789,-201.46 -376,-21 C-469,163 67.623,174.21 256,121 C564,34 250.829,-141.693 19.107,-116.936" transform="translate(400, 179) scale(0.9791)" stroke-linejoin="round" stroke-linecap="round" stroke-width="8" pathLength="1"/></svg></span>`;
  },
);
processedHeadline = processedHeadline.replace(
  /<mark>(.*?)<\/mark>/g,
  `<span class="highlighted-word">$1</span>`,
);
---

<div class="casestudies-section" data-variant={sectionVariant}>
  <Container class="relative">
    {/* Header */}
    <div class="mb-12 text-center lg:mb-16">
      <h2
        class="casestudies-headline scale-up text-3xl leading-tight font-bold sm:text-4xl lg:text-5xl"
        set:html={processedHeadline}
      />
    </div>

    {/* Cases */}
    <div class="space-y-6">
      {
        cases.map((caseItem, index) => (
          <div
            class="casestudies-card fade-up group relative overflow-hidden border p-6 transition-all duration-300 lg:p-8"
            style={`transition-delay: ${index * 100}ms;`}
          >
            {/* Glow effect */}
            <div class="casestudies-glow pointer-events-none absolute inset-0 opacity-0 transition-opacity duration-300 group-hover:opacity-100" />

            <div class="relative z-10">
              {/* Header with number and context */}
              <div class="mb-4 flex flex-wrap items-start justify-between gap-4">
                <div class="flex items-center gap-4">
                  <span class="casestudies-number flex h-10 w-10 flex-shrink-0 items-center justify-center text-sm font-bold">
                    {String(index + 1).padStart(2, "0")}
                  </span>
                  <h3 class="casestudies-title text-xl font-bold">
                    {caseItem.title}
                  </h3>
                </div>
                <span class="casestudies-context inline-flex items-center gap-1 border px-3 py-1 text-xs font-medium">
                  <Icon name="heroicons:building-storefront-16-solid" class="h-3 w-3" />
                  {caseItem.context}
                </span>
              </div>

              {/* Content Grid */}
              <div class="grid gap-4 sm:grid-cols-3">
                {/* Challenge */}
                <div class="casestudies-block p-4">
                  <div class="mb-2 flex items-center gap-2">
                    <Icon
                      name="heroicons:exclamation-triangle-16-solid"
                      class="casestudies-block-icon h-4 w-4"
                    />
                    <span class="casestudies-block-label text-xs font-semibold uppercase tracking-wider">
                      Herausforderung
                    </span>
                  </div>
                  <p class="casestudies-block-text text-sm leading-relaxed">
                    {caseItem.challenge}
                  </p>
                </div>

                {/* Approach */}
                <div class="casestudies-block p-4">
                  <div class="mb-2 flex items-center gap-2">
                    <Icon
                      name="heroicons:wrench-screwdriver-16-solid"
                      class="casestudies-block-icon h-4 w-4"
                    />
                    <span class="casestudies-block-label text-xs font-semibold uppercase tracking-wider">
                      Ansatz
                    </span>
                  </div>
                  <p class="casestudies-block-text text-sm leading-relaxed">
                    {caseItem.approach}
                  </p>
                </div>

                {/* Result */}
                <div class="casestudies-block casestudies-block-result p-4">
                  <div class="mb-2 flex items-center gap-2">
                    <Icon
                      name="heroicons:check-badge-16-solid"
                      class="casestudies-block-icon h-4 w-4"
                    />
                    <span class="casestudies-block-label text-xs font-semibold uppercase tracking-wider">
                      Ergebnis
                    </span>
                  </div>
                  <p class="casestudies-block-text text-sm leading-relaxed font-medium">
                    {caseItem.result}
                  </p>
                </div>
              </div>
            </div>
          </div>
        ))
      }
    </div>
  </Container>
</div>

<script>
  import "@scripts/animations";
</script>

<style>
  /* ========================================
     Headline styles
     ======================================== */
  .casestudies-headline {
    color: var(--section-text);
  }

  /* ========================================
     Circled Word Animation
     ======================================== */
  .casestudies-headline :global(.circled-word) {
    position: relative;
    display: inline-block;
    white-space: nowrap;
    color: var(--section-text); /* Adapts to section theme */
  }

  .casestudies-headline :global(.circled-word__svg) {
    position: absolute;
    top: 50%;
    left: 50%;
    width: 130%;
    height: 110%;
    transform: translate(-50%, -50%);
    pointer-events: none;
    overflow: visible;
  }

  .casestudies-headline :global(.circled-word__path) {
    stroke: #c8ff00;
    stroke-dasharray: 1;
    stroke-dashoffset: 1;
    transition: stroke-dashoffset 0.7s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .casestudies-headline.is-visible :global(.circled-word__path) {
    stroke-dashoffset: 0;
  }

  .casestudies-headline.is-visible :global(.circled-word[data-circled-index="0"]) :global(.circled-word__path) {
    transition-delay: 0.5s;
  }

  @media (prefers-reduced-motion: reduce) {
    .casestudies-headline :global(.circled-word__path) {
      stroke-dashoffset: 0;
      transition: none;
    }
  }

  .casestudies-headline :global(.highlighted-word) {
    color: var(--section-accent); /* Lime on dark, adapts to theme */
  }

  /* ========================================
     Card styles - Glassmorphism
     ======================================== */
  .casestudies-card {
    background: var(--section-card-bg);
    border-color: var(--section-card-border);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
  }

  .casestudies-card:hover {
    border-color: rgba(255, 255, 255, 0.15);
    background: rgba(255, 255, 255, 0.06);
  }

  .casestudies-glow {
    background: radial-gradient(
      800px circle at 50% 50%,
      color-mix(in srgb, var(--section-accent) 6%, transparent),
      transparent 40%
    );
  }

  /* ========================================
     Number and title styles
     ======================================== */
  .casestudies-number {
    background: color-mix(in srgb, var(--section-accent) 15%, transparent);
    color: var(--section-accent);
  }

  .casestudies-title {
    color: var(--section-text);
  }

  /* ========================================
     Context badge
     ======================================== */
  .casestudies-context {
    background: color-mix(in srgb, var(--section-accent) 8%, transparent);
    border-color: color-mix(in srgb, var(--section-accent) 20%, transparent);
    color: var(--section-text-muted);
  }

  /* ========================================
     Block styles
     ======================================== */
  .casestudies-block {
    background: color-mix(in srgb, var(--section-card-border) 30%, transparent);
  }

  .casestudies-block-result {
    background: color-mix(in srgb, var(--section-accent) 10%, transparent);
  }

  .casestudies-block-icon {
    color: var(--section-accent);
  }

  .casestudies-block-label {
    color: var(--section-text-muted);
  }

  .casestudies-block-text {
    color: var(--section-text);
  }

  .casestudies-block-result .casestudies-block-text {
    color: var(--section-text); /* Adapts to theme */
  }
</style>
