---
import Container from "@components/shared/Container.astro";
import Button from "@components/shared/Button.astro";
import { Icon } from "astro-icon/components";
import type { SectionVariant } from "../../types";

interface Reference {
  image: string;
  imageAlt?: string;
  title: string;
  href?: string;
  description?: string;
  tags?: string[];
}

interface Props {
  sectionVariant?: SectionVariant;
  badge?: string;
  badgeIcon?: string;
  headline?: string;
  description?: string;
  ctaText?: string;
  ctaHref?: string;
  references?: Reference[];
  maxVisibleTags?: number;
}

const {
  sectionVariant = "light",
  badge = "Referenzen",
  badgeIcon = "heroicons:star-16-solid",
  headline = "Erfolgreiche <em>Projekte</em>",
  description = "Entdecke, wie wir E-Commerce Brands dabei helfen, profitabel zu wachsen.",
  ctaText = "Alle Referenzen",
  ctaHref = "/referenzen",
  references = [
    {
      image:
        "https://images.unsplash.com/photo-1556742049-0cfed4f6a45d?w=800&h=600&fit=crop",
      title: "Fashion Brand Relaunch",
      href: "/projekte/fashion-brand",
      description:
        "Komplettes Shopify Theme Design und Entwicklung mit Fokus auf Mobile-First.",
      tags: ["Shopify", "Theme Dev", "Fashion"],
    },
    {
      image:
        "https://images.unsplash.com/photo-1460925895917-afdab827c52f?w=800&h=600&fit=crop",
      title: "E-Commerce SEO Strategie",
      href: "/projekte/ecommerce-seo",
      description:
        "Organisches Traffic-Wachstum von +180% in 6 Monaten durch gezielte SEO.",
      tags: ["SEO", "Content"],
    },
    {
      image:
        "https://images.unsplash.com/photo-1551288049-bebda4e38f71?w=800&h=600&fit=crop",
      title: "Performance Marketing",
      href: "/projekte/performance",
      description:
        "ROAS-Steigerung von 340% durch optimierte Meta und Google Ads Kampagnen.",
      tags: ["Meta Ads", "Google Ads", "Klaviyo"],
    },
  ],
  maxVisibleTags = 3,
} = Astro.props;

// Process headline: replace <em> tags with styled spans
const highlightStyle = `color: var(--section-accent);`;
const processedHeadline = headline.replace(
  /<em>(.*?)<\/em>/g,
  `<span style="${highlightStyle}">$1</span>`,
);

// Determine button variant based on section theme
const isDarkVariant = sectionVariant === "dark" || sectionVariant === "primary";
const buttonVariant =
  sectionVariant === "primary"
    ? "white"
    : isDarkVariant
      ? "secondary-dark"
      : "secondary";
---

<div class="references-section w-full" data-variant={sectionVariant}>
  {/* Header */}
  <Container class="mb-12 lg:mb-16">
    <div class="text-center">
      {/* Badge */}
      {
        badge && (
          <div class="blur-in mb-4 flex justify-center">
            <div class="references-badge shadow-inner-blur flex items-center rounded-full">
              <div class="references-badge-inner flex h-full w-full items-center space-x-2 rounded-full border px-4 py-1.5">
                {badgeIcon && (
                  <Icon
                    name={badgeIcon}
                    class="references-badge-icon h-4 w-4"
                  />
                )}
                <span class="references-badge-text text-sm font-medium">
                  {badge}
                </span>
              </div>
            </div>
          </div>
        )
      }

      {/* Headline */}
      <h2
        class="references-headline scale-up text-3xl leading-tight font-bold sm:text-4xl lg:text-5xl"
        style="transition-delay: 100ms;"
        set:html={processedHeadline}
      />

      {/* Description */}
      {
        description && (
          <p
            class="references-description fade-up mx-auto mt-4 max-w-2xl text-lg"
            style="transition-delay: 200ms;"
          >
            {description}
          </p>
        )
      }
    </div>
  </Container>

  {/* Scroll Container */}
  <div class="references-scroll-container overflow-hidden">
    <div class="references-track flex gap-4 pl-5 lg:gap-8 lg:pl-10 xl:pl-20">
      {
        references.map((reference) => (
          <article class="references-card group/card 3xl:w-[25vw] relative w-[75%] min-w-72 flex-none shrink-0 sm:w-[45%] lg:w-[30%]">
            {/* Image */}
            <div class="relative aspect-4/3 overflow-clip rounded-xl transition-transform duration-500 ease-out group-hover/card:scale-[1.02]">
              <img
                src={reference.image}
                alt={reference.imageAlt || reference.title}
                class="h-full w-full object-cover"
                loading="lazy"
                decoding="async"
              />
            </div>

            {/* Title */}
            <h3 class="references-card-title mt-5 mb-2 text-xl leading-snug font-bold lg:text-2xl">
              {reference.href ? (
                <a
                  href={reference.href}
                  class="before:absolute before:inset-0 before:block"
                >
                  {reference.title}
                </a>
              ) : (
                reference.title
              )}
            </h3>

            {/* Description */}
            {reference.description && (
              <p class="references-card-description text-sm leading-relaxed lg:text-base">
                {reference.description}
              </p>
            )}

            {/* Tags */}
            {reference.tags && reference.tags.length > 0 && (
              <div class="mt-4 flex flex-wrap gap-2">
                {reference.tags.slice(0, maxVisibleTags).map((tag) => (
                  <span class="references-tag rounded-full border px-3 py-1 text-xs font-medium lg:text-sm">
                    {tag}
                  </span>
                ))}
                {reference.tags.length > maxVisibleTags && (
                  <span class="references-tag rounded-full border px-3 py-1 text-xs font-medium lg:text-sm">
                    +{reference.tags.length - maxVisibleTags}
                  </span>
                )}
              </div>
            )}
          </article>
        ))
      }
      {/* Right spacing after last reference */}
      <div
        class="references-end-spacer w-[20vw] min-w-20 shrink-0 lg:w-[30vw]"
        aria-hidden="true"
      >
      </div>
    </div>
  </div>

  {/* CTA */}
  {
    ctaText && ctaHref && (
      <div class="mt-12 text-center lg:mt-16">
        <Button href={ctaHref} variant={buttonVariant} size="lg">
          <span>{ctaText}</span>
          <Icon name="heroicons:arrow-right-16-solid" class="h-4 w-4" />
        </Button>
      </div>
    )
  }
</div>

<script>
  import { gsap } from "gsap";
  import { ScrollTrigger } from "gsap/ScrollTrigger";

  gsap.registerPlugin(ScrollTrigger);

  const REFERENCES_TRIGGER_ID = "references-horizontal-scroll";

  function initReferencesScroll(): void {
    const sections = document.querySelectorAll<HTMLDivElement>(
      ".references-section",
    );

    sections.forEach((section, index) => {
      const container = section.querySelector<HTMLDivElement>(
        ".references-scroll-container",
      );
      const track =
        container?.querySelector<HTMLDivElement>(".references-track");

      if (!container || !track) return;

      // Skip if already initialized
      if (section.dataset.referencesInit === "true") return;
      section.dataset.referencesInit = "true";

      // Kill only our own ScrollTriggers by ID
      const triggerId = `${REFERENCES_TRIGGER_ID}-${index}`;
      ScrollTrigger.getById(triggerId)?.kill();

      // Calculate scroll distance
      const scrollWidth = track.scrollWidth;
      const containerWidth = container.offsetWidth;
      const scrollDistance = scrollWidth - containerWidth;

      // Only apply GSAP scroll if there's content to scroll
      if (scrollDistance > 0) {
        gsap.to(track, {
          x: -scrollDistance,
          ease: "none",
          scrollTrigger: {
            id: triggerId,
            trigger: section,
            start: "top 10%",
            end: () => `+=${scrollDistance}`,
            pin: true,
            scrub: 1,
            anticipatePin: 1,
            invalidateOnRefresh: true,
          },
        });
      }

      // Keep drag functionality as fallback/enhancement
      let isDown = false;
      let startX: number;
      let currentX = 0;

      container.addEventListener("mousedown", (e) => {
        isDown = true;
        container.classList.add("is-dragging");
        startX = e.pageX;
        const transform = gsap.getProperty(track, "x") as number;
        currentX = transform || 0;
      });

      container.addEventListener("mouseleave", () => {
        isDown = false;
        container.classList.remove("is-dragging");
      });

      container.addEventListener("mouseup", () => {
        isDown = false;
        container.classList.remove("is-dragging");
      });

      container.addEventListener("mousemove", (e) => {
        if (!isDown) return;
        e.preventDefault();
        const walk = (e.pageX - startX) * 1.5;
        const newX = Math.max(-scrollDistance, Math.min(0, currentX + walk));
        gsap.set(track, { x: newX });
      });
    });
  }

  // Initialize after a delay to ensure other ScrollTriggers are set up first
  function delayedInit() {
    // Wait for other components to initialize their ScrollTriggers
    setTimeout(() => {
      initReferencesScroll();
      // Refresh ScrollTrigger to recalculate positions after all triggers are set
      ScrollTrigger.refresh();
    }, 100);
  }

  // Initialize on page load
  if (document.readyState === "complete") {
    delayedInit();
  } else {
    window.addEventListener("load", delayedInit);
  }

  // Re-initialize on Astro page transitions
  document.addEventListener("astro:page-load", () => {
    // Reset initialization flags
    document
      .querySelectorAll<HTMLDivElement>(".references-section")
      .forEach((section) => {
        section.dataset.referencesInit = "false";
      });
    delayedInit();
  });
</script>

<style>
  /* ========================================
     Uses --section-* variables set by data-section-theme
     attribute on parent Section component
     ======================================== */

  /* ========================================
     Badge styles
     ======================================== */
  .references-badge {
    background: color-mix(in srgb, var(--section-accent) 15%, transparent);
  }

  .references-badge-inner {
    border-color: color-mix(in srgb, var(--section-accent) 30%, transparent);
  }

  .references-badge-icon {
    color: var(--section-accent);
  }

  .references-badge-text {
    color: var(--section-text);
  }

  /* ========================================
     Headline styles
     ======================================== */
  .references-headline {
    color: var(--section-text);
  }

  .references-description {
    color: var(--section-text-muted);
  }

  /* ========================================
     Scroll container styles
     ======================================== */
  .references-scroll-container {
    -ms-overflow-style: none;
    scrollbar-width: none;
    cursor: grab;
  }

  .references-scroll-container::-webkit-scrollbar {
    display: none;
  }

  .references-scroll-container.is-dragging {
    cursor: grabbing;
    scroll-behavior: auto;
  }

  .references-scroll-container.is-dragging * {
    pointer-events: none;
  }

  /* ========================================
     Card styles
     ======================================== */
  .references-card-title {
    color: var(--section-text);
  }

  .references-card-title a:hover {
    color: var(--section-accent);
  }

  .references-card-description {
    color: var(--section-text-muted);
  }

  /* ========================================
     Tag styles
     ======================================== */
  .references-tag {
    background: color-mix(in srgb, var(--section-accent) 5%, transparent);
    border-color: color-mix(in srgb, var(--section-accent) 20%, transparent);
    color: var(--section-text-muted);
    transition: all 0.2s ease;
  }

  .group\/card:hover .references-tag {
    background: color-mix(in srgb, var(--section-accent) 10%, transparent);
    border-color: color-mix(in srgb, var(--section-accent) 30%, transparent);
    color: var(--section-accent);
  }
</style>
