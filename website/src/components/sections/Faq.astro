---
import Container from "@components/shared/Container.astro";
import { Icon } from "astro-icon/components";
import type { SectionVariant } from "../../types";

interface Faq {
  question: string;
  answer: string;
}

interface Props {
  sectionVariant?: SectionVariant;
  badge?: string;
  headline?: string;
  description?: string;
  faqs?: Faq[];
}

const {
  sectionVariant = "dark",
  badge = "FAQs",
  headline = "Häufig gestellte <em>Fragen</em>",
  description = 'Noch Fragen? <a href="/kontakt" class="faq__link">Kontaktieren Sie mich</a> für ein unverbindliches Gespräch.',
  faqs = [],
} = Astro.props;

// Process headline: replace <em> tags with styled spans
const highlightStyle = `color: #c8ff00;`;
const processedHeadline = headline.replace(
  /<em>(.*?)<\/em>/g,
  `<span style="${highlightStyle}">$1</span>`,
);
---

<div class="faq" data-variant={sectionVariant}>
  <Container class="relative max-w-[900px]">
    {/* Header */}
    <div class="mb-14 text-center">
      {badge && (
        <p class="faq__eyebrow blur-in mb-4 text-sm font-semibold uppercase tracking-wider">
          {badge}
        </p>
      )}
      <h2
        class="faq__headline scale-up text-3xl leading-tight font-bold sm:text-4xl lg:text-5xl"
        style="transition-delay: 100ms;"
        set:html={processedHeadline}
      />
      {description && (
        <p
          class="faq__description fade-up mx-auto mt-4 max-w-2xl text-lg"
          style="transition-delay: 200ms;"
          set:html={description}
        />
      )}
    </div>

    {/* FAQ Accordion */}
    <div class="faq-container space-y-3">
      {
        faqs.map((faq, index) => (
          <details
            class="faq-item fade-up group"
            style={`transition-delay: ${250 + index * 50}ms;`}
          >
            <summary class="faq__summary">
              {/* Number */}
              <span class="faq__number">
                {String(index + 1).padStart(2, "0")}
              </span>

              {/* Question */}
              <h3 class="faq__question">{faq.question}</h3>

              {/* Toggle Icon */}
              <span class="faq__toggle">
                <Icon
                  name="heroicons:plus-16-solid"
                  class="faq__toggle-icon faq__toggle-icon--plus"
                />
                <Icon
                  name="heroicons:minus-16-solid"
                  class="faq__toggle-icon faq__toggle-icon--minus"
                />
              </span>
            </summary>

            {/* Answer */}
            <div class="faq__content">
              <div class="faq__content-inner">
                <p class="faq__answer" set:html={faq.answer} />
              </div>
            </div>
          </details>
        ))
      }
    </div>
  </Container>
</div>

<script>
  import "@scripts/animations";

  function initFaqAnimation(): void {
    const faqItems = document.querySelectorAll<HTMLDetailsElement>(".faq-item");
    const ANIMATION_DURATION = 400;

    function closeDetails(details: HTMLDetailsElement): void {
      const content = details.querySelector(".faq__content") as HTMLElement;
      if (!content) return;
      content.style.height = "0px";
      setTimeout(() => {
        details.removeAttribute("open");
      }, ANIMATION_DURATION);
    }

    function openDetails(details: HTMLDetailsElement): void {
      const content = details.querySelector(".faq__content") as HTMLElement;
      const contentInner = details.querySelector(
        ".faq__content-inner",
      ) as HTMLElement;
      if (!content || !contentInner) return;

      details.setAttribute("open", "");
      const height = contentInner.offsetHeight;
      content.style.height = `${height}px`;
    }

    faqItems.forEach((details) => {
      const summary = details.querySelector("summary");
      const content = details.querySelector(".faq__content") as HTMLElement;

      if (!summary || !content) return;

      content.style.height = "0px";
      content.style.transition = `height ${ANIMATION_DURATION}ms cubic-bezier(0.4, 0, 0.2, 1)`;

      summary.addEventListener("click", (e) => {
        e.preventDefault();
        const isOpen = details.hasAttribute("open");
        if (isOpen) {
          closeDetails(details);
        } else {
          openDetails(details);
        }
      });
    });
  }

  initFaqAnimation();
  document.addEventListener("astro:after-swap", initFaqAnimation);
</script>

<style>
  /* ========================================
     FAQ Section - Industrial Refined Style
     Navy + Lime, Clean Lines, No Border-Radius
     ======================================== */

  /* ========================================
     Eyebrow & Headline
     ======================================== */
  .faq__eyebrow {
    color: #c8ff00;
    letter-spacing: 0.15em;
  }

  .faq__headline {
    color: #ffffff;
  }

  .faq__description {
    color: rgba(255, 255, 255, 0.6);
  }

  .faq__description :global(.faq__link) {
    color: #c8ff00;
    text-decoration: underline;
    text-underline-offset: 3px;
    transition: opacity 0.2s ease;
  }

  .faq__description :global(.faq__link:hover) {
    opacity: 0.8;
  }

  /* ========================================
     FAQ Item Container
     ======================================== */
  .faq-item {
    position: relative;
  }

  /* ========================================
     Summary (Question Row)
     ======================================== */
  .faq__summary {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1.25rem 1.5rem;
    cursor: pointer;
    list-style: none;
    background: rgba(255, 255, 255, 0.02);
    border: 1px solid rgba(255, 255, 255, 0.08);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .faq__summary::-webkit-details-marker {
    display: none;
  }

  .faq__summary:hover {
    background: rgba(255, 255, 255, 0.05);
    border-color: rgba(200, 255, 0, 0.2);
  }

  /* Open state */
  .faq-item[open] .faq__summary {
    background: rgba(200, 255, 0, 0.05);
    border-color: rgba(200, 255, 0, 0.25);
    border-bottom-color: transparent;
  }

  /* ========================================
     Number Badge
     ======================================== */
  .faq__number {
    flex-shrink: 0;
    width: 2.5rem;
    height: 2.5rem;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.75rem;
    font-weight: 700;
    font-variant-numeric: tabular-nums;
    color: rgba(255, 255, 255, 0.4);
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .faq__summary:hover .faq__number {
    color: #c8ff00;
    border-color: rgba(200, 255, 0, 0.3);
    background: rgba(200, 255, 0, 0.1);
  }

  .faq-item[open] .faq__number {
    color: #0a1628;
    background: #c8ff00;
    border-color: #c8ff00;
  }

  /* ========================================
     Question Text
     ======================================== */
  .faq__question {
    flex: 1;
    font-size: 1.125rem;
    font-weight: 600;
    color: #ffffff;
    line-height: 1.4;
  }

  @media (max-width: 640px) {
    .faq__question {
      font-size: 1rem;
    }
  }

  /* ========================================
     Toggle Icon
     ======================================== */
  .faq__toggle {
    flex-shrink: 0;
    width: 2rem;
    height: 2rem;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
    border: 1px solid rgba(255, 255, 255, 0.15);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .faq__summary:hover .faq__toggle {
    border-color: rgba(200, 255, 0, 0.3);
    background: rgba(200, 255, 0, 0.05);
  }

  .faq-item[open] .faq__toggle {
    border-color: rgba(200, 255, 0, 0.4);
    background: rgba(200, 255, 0, 0.1);
  }

  .faq__toggle-icon {
    width: 1rem;
    height: 1rem;
    color: rgba(255, 255, 255, 0.5);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    position: absolute;
  }

  .faq__summary:hover .faq__toggle-icon {
    color: #c8ff00;
  }

  .faq__toggle-icon--plus {
    opacity: 1;
    transform: rotate(0deg);
  }

  .faq__toggle-icon--minus {
    opacity: 0;
    transform: rotate(-90deg);
    color: #c8ff00;
  }

  .faq-item[open] .faq__toggle-icon--plus {
    opacity: 0;
    transform: rotate(90deg);
  }

  .faq-item[open] .faq__toggle-icon--minus {
    opacity: 1;
    transform: rotate(0deg);
  }

  /* ========================================
     Content (Answer)
     ======================================== */
  .faq__content {
    overflow: hidden;
  }

  .faq__content-inner {
    padding: 0 1.5rem 1.5rem 1.5rem;
    padding-left: calc(1.5rem + 2.5rem + 1rem); /* Align with question text */
    background: rgba(200, 255, 0, 0.02);
    border: 1px solid rgba(200, 255, 0, 0.25);
    border-top: none;
    position: relative;
  }

  /* Lime accent line */
  .faq__content-inner::before {
    content: "";
    position: absolute;
    left: calc(1.5rem + 1.25rem - 1px);
    top: 0;
    bottom: 1.5rem;
    width: 2px;
    background: linear-gradient(
      to bottom,
      #c8ff00 0%,
      rgba(200, 255, 0, 0.3) 100%
    );
  }

  .faq__answer {
    color: rgba(255, 255, 255, 0.7);
    line-height: 1.7;
    font-size: 1rem;
    padding-top: 1rem;
  }

  .faq__answer :global(a) {
    color: #c8ff00;
    text-decoration: underline;
    text-underline-offset: 2px;
    transition: opacity 0.2s ease;
  }

  .faq__answer :global(a:hover) {
    opacity: 0.8;
  }

  /* ========================================
     Light/White Variant Override
     ======================================== */
  .faq[data-variant="light"] .faq__eyebrow,
  .faq[data-variant="white"] .faq__eyebrow {
    color: var(--primary);
  }

  .faq[data-variant="light"] .faq__headline,
  .faq[data-variant="white"] .faq__headline {
    color: #1c1c1e;
  }

  .faq[data-variant="light"] .faq__description,
  .faq[data-variant="white"] .faq__description {
    color: rgb(75 85 99);
  }

  .faq[data-variant="light"] .faq__description :global(.faq__link),
  .faq[data-variant="white"] .faq__description :global(.faq__link) {
    color: var(--primary);
  }

  .faq[data-variant="light"] .faq__summary,
  .faq[data-variant="white"] .faq__summary {
    background: rgba(0, 0, 0, 0.02);
    border-color: rgba(0, 0, 0, 0.1);
  }

  .faq[data-variant="light"] .faq__summary:hover,
  .faq[data-variant="white"] .faq__summary:hover {
    background: rgba(0, 0, 0, 0.04);
    border-color: color-mix(in srgb, var(--primary) 30%, transparent);
  }

  .faq[data-variant="light"] .faq-item[open] .faq__summary,
  .faq[data-variant="white"] .faq-item[open] .faq__summary {
    background: color-mix(in srgb, var(--primary) 5%, transparent);
    border-color: color-mix(in srgb, var(--primary) 30%, transparent);
  }

  .faq[data-variant="light"] .faq__number,
  .faq[data-variant="white"] .faq__number {
    color: rgba(0, 0, 0, 0.4);
    background: rgba(0, 0, 0, 0.05);
    border-color: rgba(0, 0, 0, 0.1);
  }

  .faq[data-variant="light"] .faq__summary:hover .faq__number,
  .faq[data-variant="white"] .faq__summary:hover .faq__number {
    color: var(--primary);
    border-color: color-mix(in srgb, var(--primary) 40%, transparent);
    background: color-mix(in srgb, var(--primary) 10%, transparent);
  }

  .faq[data-variant="light"] .faq-item[open] .faq__number,
  .faq[data-variant="white"] .faq-item[open] .faq__number {
    color: white;
    background: var(--primary);
    border-color: var(--primary);
  }

  .faq[data-variant="light"] .faq__question,
  .faq[data-variant="white"] .faq__question {
    color: #1c1c1e;
  }

  .faq[data-variant="light"] .faq__toggle,
  .faq[data-variant="white"] .faq__toggle {
    border-color: rgba(0, 0, 0, 0.15);
  }

  .faq[data-variant="light"] .faq__summary:hover .faq__toggle,
  .faq[data-variant="white"] .faq__summary:hover .faq__toggle {
    border-color: color-mix(in srgb, var(--primary) 40%, transparent);
    background: color-mix(in srgb, var(--primary) 5%, transparent);
  }

  .faq[data-variant="light"] .faq-item[open] .faq__toggle,
  .faq[data-variant="white"] .faq-item[open] .faq__toggle {
    border-color: color-mix(in srgb, var(--primary) 50%, transparent);
    background: color-mix(in srgb, var(--primary) 10%, transparent);
  }

  .faq[data-variant="light"] .faq__toggle-icon,
  .faq[data-variant="white"] .faq__toggle-icon {
    color: rgba(0, 0, 0, 0.4);
  }

  .faq[data-variant="light"] .faq__summary:hover .faq__toggle-icon,
  .faq[data-variant="white"] .faq__summary:hover .faq__toggle-icon {
    color: var(--primary);
  }

  .faq[data-variant="light"] .faq__toggle-icon--minus,
  .faq[data-variant="white"] .faq__toggle-icon--minus {
    color: var(--primary);
  }

  .faq[data-variant="light"] .faq__content-inner,
  .faq[data-variant="white"] .faq__content-inner {
    background: color-mix(in srgb, var(--primary) 2%, white);
    border-color: color-mix(in srgb, var(--primary) 30%, transparent);
  }

  .faq[data-variant="light"] .faq__content-inner::before,
  .faq[data-variant="white"] .faq__content-inner::before {
    background: linear-gradient(
      to bottom,
      var(--primary) 0%,
      color-mix(in srgb, var(--primary) 30%, transparent) 100%
    );
  }

  .faq[data-variant="light"] .faq__answer,
  .faq[data-variant="white"] .faq__answer {
    color: rgb(75 85 99);
  }

  .faq[data-variant="light"] .faq__answer :global(a),
  .faq[data-variant="white"] .faq__answer :global(a) {
    color: var(--primary);
  }
</style>
